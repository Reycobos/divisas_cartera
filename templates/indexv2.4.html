<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Delta Neutral Portfolio</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Estilos existentes (manteniendo todos los dem√°s) */
      body {
        background-color: #0d1117;
        color: #c9d1d9;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        line-height: 1;
      }
      .container-fluid {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
      .container {
        margin-left: 10px !important;
        margin-right: auto;
      }
      h1,
      h4 {
        color: #f0f6fc;
        font-weight: 600;
        margin-top: 8px;
        margin-bottom: 8px;
      }
      h1 {
        font-size: 1.5rem;
        padding: 8px 0;
      }
      .nav-tabs {
        margin-bottom: 10px;
      }
      .nav-tabs .nav-link {
        color: #8b949e;
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }
      .nav-tabs .nav-link.active {
        background-color: #161b22;
        color: #f0f6fc;
      }
      .card {
        background-color: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-bottom: 12px;
        padding: 8px;
      }
      .table {
        color: #c9d1d9;
        --bs-table-bg: transparent;
        --bs-table-striped-bg: #171c28;
        --bs-table-striped-color: #c9d1d9;
        --bs-table-hover-bg: #22283a;
        --bs-table-hover-color: #c9d1d9;
        border-color: #30363d;
        font-size: 0.85rem;
        margin-bottom: 0.2rem !important;
      }
      .table > :not(caption) > * > * {
        background-color: #1e1e2d !important;
        color: #e8e8e8 !important;
        border-color: #30363d !important;
        white-space: nowrap;
        vertical-align: middle;
        padding: 0.4rem 0.5rem;
      }
      .table .pnl-positive {
        color: #2ecc71 !important;
        font-weight: 600;
      }
      .table .pnl-negative {
        color: #e74c3c !important;
        font-weight: 600;
      }
      .table thead th,
      .table thead td {
        background-color: #2a2a3d;
        color: #fff;
        font-size: 0.8rem;
        padding: 0.5rem;
      }
      .table tbody tr {
        background-color: #1e1e2d;
        color: #e8e8e8 !important;
      }
      .table-hover > tbody > tr:hover > * {
        background-color: #22283a !important;
      }
      .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: #171c28 !important;
      }
      .refresh-btn {
        background: #222;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
      }
      .refresh-btn:hover {
        background: #444;
      }
      .pnl-positive {
        color: #2ecc71;
        font-weight: 600;
      }
      .pnl-negative {
        color: #e74c3c;
        font-weight: 600;
      }

      /* ESTILOS NUEVOS PARA BALANCES COMPACTOS */
      .balances-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        border-radius: 12px;
        color: white;
      }
      .balances-header h2 {
        margin: 0;
        font-size: 1.8rem;
      }
      .balances-summary {
        display: flex;
        gap: 20px;
      }
      .balance-summary-item {
        text-align: right;
      }
      .balance-summary-label {
        font-size: 0.85rem;
        opacity: 0.9;
      }
      .balance-summary-value {
        font-size: 1.1rem;
        font-weight: bold;
      }

      .balances-table {
        margin-top: 10px;
      }
      .balances-table .table {
        margin-bottom: 0;
      }
      .balances-table th,
      .balances-table td {
        text-align: right;
      }
      .balances-table th:first-child,
      .balances-table td:first-child {
        text-align: left;
      }

      .force-select-grid,
      .funding-select-grid {
        max-height: 220px;
        overflow-y: auto;
        background-color: #111625;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .force-select-grid .form-check,
      .funding-select-grid .form-check {
        flex: 0 0 48%;
        margin-bottom: 4px;
      }
      @media (max-width: 768px) {
        .force-select-grid .form-check,
        .funding-select-grid .form-check {
          flex: 0 0 100%;
        }
      }

      /* Estilos para otros componentes (manteniendo los existentes) */
      .card-exchange {
        background: #2b2f3a;
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
      }
      .card-exchange h5 {
        margin: 0;
        font-size: 1.2rem;
        color: #f0f6fc;
      }
      .value-positive {
        color: #2ecc71;
        font-weight: bold;
      }
      .value-negative {
        color: #e74c3c;
        font-weight: bold;
      }
      .strategy-card {
        background-color: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 0;
        margin-bottom: 1px;
      }
      .strategy-header {
        background: linear-gradient(90deg, #1e3a8a, #2563eb);
        color: white;
        padding: 0.2px 12px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
      }
      .badge-long {
        background-color: #16a34a;
      }
      .badge-short {
        background-color: #dc2626;
      }
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
        margin-top: 8px;
        text-align: center;
      }
      .summary-item {
        background-color: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 2px 6px;
      }
      .summary-item h6 {
        margin: 0;
        font-size: 0.75rem;
        color: #8b949e;
      }
      .summary-item p {
        margin: 0;
        font-size: 0.95rem;
        font-weight: bold;
      }
      .risk-pill {
        padding: 2px 6px;
        border-radius: 6px;
        font-weight: 600;
        display: inline-block;
      }
      .risk-red {
        background: #b91c1c;
        color: #fff;
      }
      .risk-orange {
        background: #ea580c;
        color: #fff;
      }
      .risk-yellow {
        background: #ca8a04;
        color: #111;
      }
      .risk-green {
        background: #16a34a;
        color: #fff;
      }
      .closed-position-card {
        background-color: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
      }
      .closed-position-header {
        background: linear-gradient(90deg, #5b2085, #37065e);
        color: white;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .closed-position-header h6 {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 600;
      }
      .closed-position-body {
        padding: 10px;
      }
      .closed-position-table {
        width: 100%;
        font-size: 0.8rem;
      }
      .closed-position-table th {
        background-color: #2a2a3d;
        color: #fff;
        padding: 6px 8px;
        text-align: center;
        font-weight: 600;
      }
      .closed-position-table th:first-child,
      .closed-position-table td:first-child {
        width: 30px;
        padding: 6px 4px;
      }
      .closed-position-table td {
        padding: 6px 8px;
        text-align: center;
        border-bottom: 1px solid #30363d;
        color: #e8e8e8 !important;
      }
      .closed-pos-checkbox,
      .select-all-card {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #dc3545;
      }
      .closed-position-footer {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #30363d;
      }
      .footer-left {
        display: flex;
        gap: 20px;
      }
      .footer-right {
        display: flex;
        gap: 20px;
      }

      .footer-item {
        text-align: center;
      }
      .footer-label {
        font-size: 0.7rem;
        color: #8b949e;
        margin-bottom: 2px;
      }
      .footer-value {
        font-size: 0.85rem;
        font-weight: 600;
        color: #e8e8e8;
      }
      .compact-badge {
        font-size: 0.7rem;
        padding: 3px 6px;
      }
      .header-summary {
        display: flex;
        gap: 15px;
        margin-top: 5px;
      }
      .header-summary-item {
        text-align: center;
      }
      .header-summary-label {
        font-size: 0.65rem;
        color: #c9d1d9;
      }
      .header-summary-value {
        font-size: 0.75rem;
        font-weight: 600;
      }
      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
        gap: 10px;
      }
      .page-btn {
        background: #2a2a3d;
        color: #e8e8e8;
        border: 1px solid #30363d;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .page-btn:hover {
        background: #3a3a4d;
      }
      .page-btn.active {
        background: #2563eb;
        color: white;
      }
      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .days-selector {
        background: #2a2a3d;
        color: #e8e8e8;
        border: 1px solid #30363d;
        padding: 8px 12px;
        border-radius: 6px;
        margin-left: 15px;
      }
      .funding-estimate {
        font-style: italic;
        opacity: 0.7;
      }
      .closed-kpis .header-summary-item,
      .closed-kpis .kpi {
        display: inline-flex;
        align-items: baseline;
        gap: 6px;
      }
      .closed-kpis .header-summary-label {
        font-size: 0.85rem;
        opacity: 0.75;
      }
      .closed-kpis .header-summary-value {
        font-weight: 600;
        font-variant-numeric: tabular-nums;
      }
      .pos-head {
        padding: 10px 12px;
      }
      .pos-head .symbol-title {
        font-size: 0.95rem;
      }
      .pill-delta {
        font-size: 0.72rem;
        padding: 2px 8px;
        border-radius: 999px;
      }
      .pos-dates {
        font-size: 0.82rem;
        opacity: 0.85;
      }
      .pos-head .metrics {
        gap: 12px;
        font-size: 0.9rem;
      }
      .pos-head .metrics .label {
        opacity: 0.8;
        font-size: 0.85rem;
      }
      .pos-card .pos-head + .position-table {
        margin-top: 8px;
      }
      #closedPositions table tbody tr:last-child td {
        border-bottom: none !important;
      }
      .top-title,
      .app-title,
      header .app-title {
        font-size: 1.05rem;
        margin-bottom: 4px;
      }
      .nav-tabs,
      .tabs-wrap {
        margin-top: 0 !important;
      }
      header,
      .app-header {
        padding-bottom: 6px;
        margin-bottom: 6px;
      }
      .pos-head .title-row {
        width: 100%;
      }
      .pos-head .pos-dates {
        margin-left: auto;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .pos-head .symbol-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: clamp(80px, 24vw, 220px);
      }
      .pill-delta {
        flex-shrink: 0;
      }
      .closed-position-header .pos-dates {
        white-space: nowrap;
        flex-shrink: 0;
      }
      .closed-position-header h6 {
        margin: 0;
      }

      /* ESTILOS PARA ORDENAMIENTO DE TABLA */
      .table-sortable th {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
      }

      .table-sortable th.sortable::after {
        content: "‚Üï";
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.5;
        font-size: 0.8rem;
      }

      .table-sortable th.sort-asc::after {
        content: "‚Üë";
        opacity: 1;
        font-weight: bold;
      }

      .table-sortable th.sort-desc::after {
        content: "‚Üì";
        opacity: 1;
        font-weight: bold;
      }

      /* ESTILOS PARA FILTROS Y PAGINACI√ìN DE CLOSED POSITIONS */
      .dark-input {
        background-color: #161b22;
        border: 1px solid #30363d;
        color: #c9d1d9;
      }

      .dark-input:focus {
        background-color: #161b22;
        border-color: #58a6ff;
        color: #c9d1d9;
        box-shadow: 0 0 0 0.2rem rgba(21, 87, 36, 0.25);
      }

      .form-label {
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .closed-pagination-info {
        color: #8b949e;
        font-size: 0.9rem;
      }
      /* Etiquetas blancas en la pesta√±a Opciones */
      #options .form-label {
        color: #fff;
      }

      /* Opcional: mejorar contraste de inputs/selects en tema oscuro */
      #options .form-control.dark-input,
      #options .form-select.dark-input {
        color: #fff;
      }
      #options .form-control.dark-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      /* Estilos para el modal oscuro */
      .modal-content {
        background-color: #161b22 !important;
        border: 1px solid #30363d;
      }

      .modal-header {
        border-bottom: 1px solid #30363d;
      }

      .modal-footer {
        border-top: 1px solid #30363d;
      }

      /* Estilos para botones de edici√≥n */
      .edit-size-btn {
        font-size: 0.75rem;
        padding: 2px 6px;
      }

      /* Estilos para botones de edici√≥n en balances */
      .btn-outline-warning {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-width: 1px;
      }

      /* Mejora visual para spreads */
      .spread-positive {
        color: #2ecc71;
        font-weight: bold;
      }

      .spread-negative {
        color: #e74c3c;
        font-weight: bold;
      }

      /* Nuevas casillas para seleccionar exchange*/
      .open-positions-layout {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px;
      }

      .exchange-filter-section {
        background-color: #161b22;
        border: 1px solid #30363d;
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        max-width: 120px;
      }

      .exchange-checkboxes {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.15rem;
      }

      .form-check {
        padding-left: 1.2rem;
        margin-bottom: 0.1rem;
      }

      .form-check-label {
        margin-left: 0.15rem;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .form-check-input:checked {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
      }

      .spread-positive {
        color: #22c55e;
      }

      .spread-negative {
        color: #ef4444;
      }

      .header-spread-grid {
        display: flex;
        gap: 16px;
        flex-wrap: nowrap;
        margin-top: 0;
        align-items: center;
      }

      .spread-box {
        background: none;
        border-radius: 0;
        padding: 0;
        min-width: 70px;
        text-align: center;
      }

      .spread-label {
        font-size: 0.65rem;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 2px;
      }

      .spread-value {
        font-size: 0.85rem;
        font-weight: 600;
      }

      .funding-mini-grid {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.75rem;
      }

      .funding-pill {
        border-radius: 4px;
        padding: 2px 6px;
        background: #0d1117;
        border: 1px solid #30363d;
        display: inline-block;
        text-align: center;
      }

      .badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 600;
      }

      .vr {
        width: 1px;
        background-color: currentColor;
        opacity: 0.3;
        align-self: stretch;
      }
    </style>
  </head>

  <body>
    <div class="container mt-4">
      <h1 class="mb-4">Delta Neutral Portfolio</h1>

      <!-- NAVIGATION TABS -->
      <ul class="nav nav-tabs" id="portfolioTabs" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            id="balances-tab"
            data-bs-toggle="tab"
            data-bs-target="#balances"
            type="button"
            role="tab"
          >
            Balances
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="positions-tab"
            data-bs-toggle="tab"
            data-bs-target="#positions"
            type="button"
            role="tab"
          >
            Open Positions
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="closed-tab"
            data-bs-toggle="tab"
            data-bs-target="#closed"
            type="button"
            role="tab"
          >
            Closed Positions
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="funding-tab"
            data-bs-toggle="tab"
            data-bs-target="#funding"
            type="button"
            role="tab"
          >
            Funding Fees
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="options-tab"
            data-bs-toggle="tab"
            data-bs-target="#options"
            type="button"
            role="tab"
          >
            Opciones
          </button>
        </li>
      </ul>

      <div class="tab-content mt-3" id="portfolioTabsContent">
        <!-- BALANCES -->
        <div class="tab-pane fade show active" id="balances" role="tabpanel">
          <div id="balances-container"></div>
        </div>

        <!-- OPEN POSITIONS -->
        <div class="tab-pane fade" id="positions" role="tabpanel">
          <div class="open-positions-layout mt-3">
            <!-- Left column: exchange filters -->
            <div class="exchange-filter-section">
              <div class="mb-2">
                <button id="refreshOpen" class="refresh-btn w-100">
                  üîÑ Refresh
                </button>
              </div>
              <label class="form-label mb-2"><strong>Exchanges:</strong></label>
              <div class="exchange-checkboxes">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check-all-exchanges"
                    checked
                  />
                  <label class="form-check-label" for="check-all-exchanges"
                    >All</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="aden"
                    id="check-aden"
                    checked
                  />
                  <label class="form-check-label" for="check-aden">Aden</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="aster"
                    id="check-aster"
                    checked
                  />
                  <label class="form-check-label" for="check-aster"
                    >Aster</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="backpack"
                    id="check-backpack"
                    checked
                  />
                  <label class="form-check-label" for="check-backpack"
                    >Backpack</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="binance"
                    id="check-binance"
                    checked
                  />
                  <label class="form-check-label" for="check-binance"
                    >Binance</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="bingx"
                    id="check-bingx"
                    checked
                  />
                  <label class="form-check-label" for="check-bingx"
                    >BingX</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="bitget"
                    id="check-bitget"
                    checked
                  />
                  <label class="form-check-label" for="check-bitget"
                    >Bitget</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="bitrue"
                    id="check-bitrue"
                    checked
                  />
                  <label class="form-check-label" for="check-bitrue"
                    >Bitrue</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="bybit"
                    id="check-bybit"
                    checked
                  />
                  <label class="form-check-label" for="check-bybit"
                    >Bybit</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="extended"
                    id="check-extended"
                    checked
                  />
                  <label class="form-check-label" for="check-extended"
                    >Extended</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="gate"
                    id="check-gate"
                    checked
                  />
                  <label class="form-check-label" for="check-gate"
                    >Gate.io</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="hyperliquid"
                    id="check-hyperliquid"
                    checked
                  />
                  <label class="form-check-label" for="check-hyperliquid"
                    >Hyperliquid</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="kraken"
                    id="check-kraken"
                    checked
                  />
                  <label class="form-check-label" for="check-kraken"
                    >Kraken</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="kucoin"
                    id="check-kucoin"
                    checked
                  />
                  <label class="form-check-label" for="check-kucoin"
                    >KuCoin</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="lbank"
                    id="check-lbank"
                    checked
                  />
                  <label class="form-check-label" for="check-lbank"
                    >Lbank</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="mexc"
                    id="check-mexc"
                    checked
                  />
                  <label class="form-check-label" for="check-mexc">MEXC</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="okx"
                    id="check-okx"
                    checked
                  />
                  <label class="form-check-label" for="check-okx">OKX</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="paradex"
                    id="check-paradex"
                    checked
                  />
                  <label class="form-check-label" for="check-paradex"
                    >Paradex</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="pacifica"
                    id="check-pacifica"
                    checked
                  />
                  <label class="form-check-label" for="check-pacifica"
                    >Pacifica</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="whitebit"
                    id="check-whitebit"
                    checked
                  />
                  <label class="form-check-label" for="check-whitebit"
                    >Whitebit</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input exchange-checkbox"
                    type="checkbox"
                    value="xt"
                    id="check-xt"
                    checked
                  />
                  <label class="form-check-label" for="check-xt">XT</label>
                </div>
              </div>
            </div>

            <!-- Right column: header + positions -->
            <div class="positions-panel">
              <!-- Header con botones -->
              <div
                class="closed-header d-flex align-items-center justify-content-between mb-3"
              >
                <div
                  class="closed-header-left d-flex align-items-center gap-3 flex-wrap"
                >
                  <h4 class="mb-0">Open Positions</h4>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <button id="btnAddManualOpen" class="btn btn-primary">
                    ‚ûï Add Manual Open
                  </button>
                </div>
              </div>
              <!-- Contenedor de posiciones -->
              <div id="positions-container"></div>
            </div>
          </div>
        </div>

        <!-- CLOSED POSITIONS -->
        <div class="tab-pane fade" id="closed" role="tabpanel">
          <!-- Header compacto -->
          <div
            class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2"
          >
            <div class="d-flex align-items-center gap-2">
              <h5 class="mb-0">Closed Positions</h5>
              <div
                id="closedTotals"
                class="closed-kpis d-flex align-items-center gap-2"
              ></div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button id="refreshClosed" class="refresh-btn btn-sm">üîÑ</button>
              <button id="loadClosed" class="btn btn-success btn-sm">
                ‚ñ∂ Load
              </button>
              <span id="loadClosedStatus" class="text-white-50 small"></span>
            </div>
          </div>

          <!-- Filtros compactos en una l√≠nea -->
          <div class="d-flex flex-wrap gap-2 mb-2 align-items-center">
            <input
              type="text"
              class="form-control form-control-sm dark-input"
              id="filterExchange"
              placeholder="Exchange"
              style="width: 120px"
            />
            <input
              type="text"
              class="form-control form-control-sm dark-input"
              id="filterSymbol"
              placeholder="Symbol"
              style="width: 120px"
            />
            <select
              class="form-select form-select-sm dark-input"
              id="filterSide"
              style="width: 110px"
            >
              <option value="">All Sides</option>
              <option value="LONG">Long</option>
              <option value="SHORT">Short</option>
              <option value="SPOTBUY">Spot Buy</option>
              <option value="SWAPSTABLE">Swap Stable</option>
              <option value="SPOTSELL">Spot Sell</option>
            </select>
            <input
              type="date"
              class="form-control form-control-sm dark-input"
              id="filterDate"
              value="2025-09-01"
              min="2025-09-01"
              style="width: 140px"
            />
            <button id="applyFilters" class="btn btn-primary btn-sm">
              Apply
            </button>
          </div>

          <!-- Controles de paginaci√≥n superior -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-3">
              <div class="d-flex align-items-center">
                <span class="text-light me-2">Show:</span>
                <select
                  id="pageSizeSelect"
                  class="form-select dark-input"
                  style="width: auto"
                >
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="30">30</option>
                </select>
                <span class="text-light ms-2">entries</span>
              </div>
              <button
                id="deleteSelectedClosed"
                class="btn btn-danger btn-sm"
                style="display: none"
              >
                üóëÔ∏è Delete Selected (<span id="selectedCount">0</span>)
              </button>
            </div>
            <div id="closedPaginationTop" class="pagination-container"></div>
          </div>

          <!-- Contenedor de posiciones cerradas -->
          <div id="closedPositions"></div>

          <!-- Controles de paginaci√≥n inferior -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div id="closedPaginationBottom" class="pagination-container"></div>
          </div>
        </div>

        <!-- FUNDING -->
        <div class="tab-pane fade" id="funding" role="tabpanel">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Funding Fees</h4>
              <div>
                <select id="daysSelector" class="days-selector">
                  <option value="7">Last 7 days</option>
                  <option value="14">Last 14 days</option>
                  <option value="30">Last 30 days</option>
                  <option value="0">All days</option>
                </select>
                <button id="refreshFunding" class="refresh-btn">
                  üîÑ Refresh
                </button>
                <label style="margin-left: 8px; font-size: 0.9rem">
                  <input type="checkbox" id="toggleEstimates" checked />
                  Show estimates
                </label>
              </div>
            </div>
            <div id="fundingPagination" class="pagination-container"></div>
            <div id="funding-container"></div>
            <div
              id="fundingPaginationBottom"
              class="pagination-container"
            ></div>
          </div>
        </div>

        <!-- OPCIONES -->
        <div class="tab-pane fade" id="options" role="tabpanel">
          <div class="card p-3">
            <h4 class="mb-3">Import Files</h4>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Exchange</label>
                <select id="opt-exchange" class="form-select dark-input">
                  <option value="ourbit" selected>Ourbit</option>
                  <option value="kcex">KCEX</option>
                  <option value="lbank">LBANK</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Tipo de posici√≥n</label>
                <select id="opt-product" class="form-select dark-input">
                  <option value="Futures position" selected>
                    Futures position
                  </option>
                  <!-- futuro: Spot position -->
                </select>
              </div>
              <div class="col-md-3" id="file1-container">
                <label class="form-label" id="file1-label"
                  >Fund flow (Funding fees)</label
                >
                <input
                  type="file"
                  id="opt-fund"
                  class="form-control dark-input"
                  accept=".xlsx,.xls,.csv"
                />
              </div>
              <div class="col-md-3" id="file2-container">
                <label class="form-label" id="file2-label"
                  >Fills history (opcional)</label
                >
                <input
                  type="file"
                  id="opt-fills"
                  class="form-control dark-input"
                  accept=".xlsx,.xls,.csv"
                />
              </div>
              <div class="col-12 d-flex gap-2">
                <button id="btn-import-ourbit" class="btn btn-primary">
                  Importar
                </button>
                <span id="import-status" class="ms-2 text-white-50"></span>
              </div>
            </div>
          </div>
          <div class="card p-3 mt-3">
            <h4 class="mb-3">Agregar posici√≥n cerrada (manual)</h4>
            <div class="row g-3" id="manual-closed-form">
              <div class="col-md-2">
                <label class="form-label">Exchange</label>
                <!-- select con exchanges (orden alfab√©tico) -->
                <select id="m-exchange" class="form-select dark-input">
                  <option value="">-- select --</option>
                  <option value="aden">Aden</option>
                  <option value="Arbitrum">Arbitrum</option>
                  <option value="aster">Aster</option>
                  <option value="backpack">Backpack</option>
                  <option value="Base OKX">Base OKX</option>
                  <option value="bitrue">bitrue</option>
                  <option value="binance">Binance</option>
                  <option value="bingx">BingX</option>
                  <option value="bitget">Bitget</option>
                  <option value="BNB OKX">BNB OKX</option>
                  <option value="bybit">Bybit</option>
                  <option value="Ethereum OKX">Ethereum OKX</option>
                  <option value="extended">Extended</option>
                  <option value="gate">Gate</option>
                  <option value="hyperliquid">Hyperliquid</option>
                  <option value="kucoin">KuCoin</option>
                  <option value="lbank">Lbank</option>
                  <option value="mexc">MEXC</option>
                  <option value="okx">OKX</option>
                  <option value="Ourbit">Ourbit</option>
                  <option value="paradex">Paradex</option>
                  <option value="pacifica">Pacifica</option>
                  <option value="Solana JUP">Solana JUP</option>
                  <option value="whitebit">WhiteBIT</option>
                  <option value="xt">XT</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Symbol</label>
                <input
                  type="text"
                  id="m-symbol"
                  class="form-control dark-input"
                  placeholder="BTCUSDT / ALPACAUSDT / ..."
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Side</label>
                <!-- lado: long / short / spotbuy / spotsell -->
                <select id="m-side" class="form-select dark-input">
                  <option value="">-- select --</option>
                  <option value="long">long</option>
                  <option value="short">short</option>
                  <option value="spotbuy">spotbuy</option>
                  <option value="spotsell">spotsell</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Size</label>
                <input
                  type="number"
                  step="0.00000001"
                  id="m-size"
                  class="form-control dark-input"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Entry price</label>
                <input
                  type="number"
                  step="0.00000001"
                  id="m-entry"
                  class="form-control dark-input"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Close price</label>
                <input
                  type="number"
                  step="0.00000001"
                  id="m-close"
                  class="form-control dark-input"
                />
              </div>

              <div class="col-md-3">
                <label class="form-label">Open time</label>
                <input
                  type="datetime-local"
                  id="m-open"
                  class="form-control dark-input"
                />
              </div>
              <div class="col-md-3">
                <label class="form-label">Close time</label>
                <input
                  type="datetime-local"
                  id="m-close-time"
                  class="form-control dark-input"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Funding total</label>
                <input
                  type="number"
                  step="0.01"
                  id="m-funding"
                  class="form-control dark-input"
                  placeholder="p.ej. -2.35"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Fee total</label>
                <input
                  type="number"
                  step="0.01"
                  id="m-fees"
                  class="form-control dark-input"
                  placeholder="p.ej. -1.20"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Realized PnL (opcional)</label>
                <input
                  type="number"
                  step="0.01"
                  id="m-realized"
                  class="form-control dark-input"
                  placeholder="si vac√≠o: se compone"
                />
              </div>

              <div class="col-md-2">
                <label class="form-label">Initial margin (opcional)</label>
                <input
                  type="number"
                  step="0.01"
                  id="m-initial-margin"
                  class="form-control dark-input"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Notional (opcional)</label>
                <input
                  type="number"
                  step="0.01"
                  id="m-notional"
                  class="form-control dark-input"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Leverage (opcional)</label>
                <input
                  type="number"
                  step="0.01"
                  id="m-leverage"
                  class="form-control dark-input"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">Liq. price (opcional)</label>
                <input
                  type="number"
                  step="0.00000001"
                  id="m-liq"
                  class="form-control dark-input"
                />
              </div>

              <div class="col-12 d-flex gap-2">
                <button id="btn-save-manual-closed" class="btn btn-success">
                  Guardar
                </button>
                <span
                  id="manual-closed-status"
                  class="ms-2 text-white-50"
                ></span>
              </div>
            </div>
          </div>
          <div class="card p-3 mt-3">
            <h4 class="mb-3">Load closed positions (force)</h4>
            <div class="row g-3">
              <div class="col-lg-6">
                <label class="form-label">Exchanges</label>
                <div class="force-select-grid" id="force-exchange-grid">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="force-check-all"
                      checked
                    />
                    <label class="form-check-label" for="force-check-all"
                      >All exchanges</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="aden"
                      id="force-ex-aden"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-aden"
                      >Aden</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="aster"
                      id="force-ex-aster"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-aster"
                      >Aster</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="backpack"
                      id="force-ex-backpack"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-backpack"
                      >Backpack</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="bitrue"
                      id="force-ex-bitrue"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-bitrue"
                      >Bitrue</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="binance"
                      id="force-ex-binance"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-binance"
                      >Binance</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="bingx"
                      id="force-ex-bingx"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-bingx"
                      >BingX</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="bitget"
                      id="force-ex-bitget"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-bitget"
                      >Bitget</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="bybit"
                      id="force-ex-bybit"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-bybit"
                      >Bybit</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="extended"
                      id="force-ex-extended"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-extended"
                      >Extended</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="gate"
                      id="force-ex-gate"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-gate"
                      >Gate</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="hyperliquid"
                      id="force-ex-hyperliquid"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-hyperliquid"
                      >Hyperliquid</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="kucoin"
                      id="force-ex-kucoin"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-kucoin"
                      >KuCoin</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="kcex"
                      id="force-ex-kcex"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-kcex"
                      >Kcex</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="lbank"
                      id="force-ex-lbank"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-lbank"
                      >Lbank</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="mexc"
                      id="force-ex-mexc"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-mexc"
                      >MEXC</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="okx"
                      id="force-ex-okx"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-okx"
                      >OKX</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="paradex"
                      id="force-ex-paradex"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-paradex"
                      >Paradex</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="pacifica"
                      id="force-ex-pacifica"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-pacifica"
                      >Pacifica</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="whitebit"
                      id="force-ex-whitebit"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-whitebit"
                      >WhiteBIT</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input force-exchange-checkbox"
                      type="checkbox"
                      value="xt"
                      id="force-ex-xt"
                      checked
                    />
                    <label class="form-check-label" for="force-ex-xt">XT</label>
                  </div>
                </div>
              </div>

              <div class="col-lg-6">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Days back (1‚Äì90)</label>
                    <input
                      type="number"
                      id="force-days"
                      class="form-control dark-input"
                      min="1"
                      max="90"
                      value="30"
                    />
                  </div>
                  <div class="col-md-6 d-flex align-items-end">
                    <button id="btn-force-closed" class="btn btn-warning w-100">
                      Load closed positions
                    </button>
                  </div>
                  <div class="col-12">
                    <span id="force-status" class="text-white-50"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card p-3 mt-3">
            <h4 class="mb-3">Load funding fees (force)</h4>
            <div class="row g-3">
              <div class="col-lg-6">
                <label class="form-label">Exchanges</label>
                <div class="funding-select-grid" id="funding-exchange-grid">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="funding-check-all"
                      checked
                    />
                    <label class="form-check-label" for="funding-check-all"
                      >All exchanges</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="backpack"
                      id="funding-ex-backpack"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-backpack"
                      >Backpack</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="aster"
                      id="funding-ex-aster"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-aster"
                      >Aster</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="binance"
                      id="funding-ex-binance"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-binance"
                      >Binance</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="aden"
                      id="funding-ex-aden"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-aden"
                      >Aden</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="extended"
                      id="funding-ex-extended"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-extended"
                      >Extended</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="kucoin"
                      id="funding-ex-kucoin"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-kucoin"
                      >KuCoin</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="mexc"
                      id="funding-ex-mexc"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-mexc"
                      >MEXC</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="gate"
                      id="funding-ex-gate"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-gate"
                      >Gate</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="okx"
                      id="funding-ex-okx"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-okx"
                      >OKX</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="bitget"
                      id="funding-ex-bitget"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-bitget"
                      >Bitget</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="bingx"
                      id="funding-ex-bingx"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-bingx"
                      >BingX</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="paradex"
                      id="funding-ex-paradex"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-paradex"
                      >Paradex</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="hyperliquid"
                      id="funding-ex-hyperliquid"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-hyperliquid"
                      >Hyperliquid</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="whitebit"
                      id="funding-ex-whitebit"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-whitebit"
                      >WhiteBIT</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="xt"
                      id="funding-ex-xt"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-xt"
                      >XT</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input funding-exchange-checkbox"
                      type="checkbox"
                      value="pacifica"
                      id="funding-ex-pacifica"
                      checked
                    />
                    <label class="form-check-label" for="funding-ex-pacifica"
                      >Pacifica</label
                    >
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Days back (1‚Äì90)</label>
                    <input
                      type="number"
                      id="funding-force-days"
                      class="form-control dark-input"
                      min="1"
                      max="90"
                      value="14"
                    />
                  </div>
                  <div class="col-md-6 d-flex align-items-end">
                    <button id="btn-force-funding" class="btn btn-info w-100">
                      Load funding fees
                    </button>
                  </div>
                  <div class="col-12">
                    <span
                      id="force-funding-status"
                      class="text-white-50"
                    ></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Edit Position -->
      <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">‚úèÔ∏è Edit Position</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Exchange</label>
                  <input
                    type="text"
                    class="form-control dark-input"
                    id="edit-exchange"
                    readonly
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Symbol</label>
                  <input
                    type="text"
                    class="form-control dark-input"
                    id="edit-symbol"
                    readonly
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Side</label>
                  <select class="form-select dark-input" id="edit-side">
                    <option value="long">Long</option>
                    <option value="short">Short</option>
                    <option value="spotbuy">Spot Buy</option>
                    <option value="spotsell">Spot Sell</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Size</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-size"
                    step="0.00000001"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Entry Price</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-entry-price"
                    step="0.00000001"
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Liquidation Price</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-liq"
                    step="0.01"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Fees</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-fees"
                    step="0.01"
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Funding Fee</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-funding"
                    step="0.01"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Realized PnL</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-realized-pnl"
                    step="0.01"
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Initial Margin</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-init-margin"
                    step="0.01"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Margin</label>
                  <input
                    type="number"
                    class="form-control dark-input"
                    id="edit-margin"
                    step="0.01"
                  />
                  <small class="text-muted"
                    >Changes will be timestamped for APR calculation</small
                  >
                </div>
              </div>
              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Note:</strong> Manual edits will override API values
                and persist in the database.
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="button" class="btn btn-primary" id="save-edit-btn">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal" id="modalManualOpen" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content bg-dark text-white">
            <div class="modal-header">
              <h5 class="modal-title">Add manual open position</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form id="formManualOpen" class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Exchange</label>
                  <select name="exchange" class="form-select">
                    <option>Arbitrum</option>
                    <option>Binance</option>
                    <option>Bingx</option>
                    <option>Bitrue</option>
                    <option>Bitget</option>
                    <option>Base OKX</option>
                    <option>BNB OKX</option>
                    <option>Ethereum OKX</option>
                    <option>EdgeX</option>
                    <option>Kcex</option>
                    <option>Lbank</option>
                    <option>Ourbit</option>
                    <option>Solana JUP</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Symbol</label>
                  <input
                    name="symbol"
                    class="form-control"
                    placeholder="e.g. BTC"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Side</label>
                  <select name="side" class="form-select">
                    <option value="long">long</option>
                    <option value="short">short</option>
                    <option value="spotbuy">spotbuy</option>
                    <option value="spotsell">spotsell</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Size</label>
                  <input
                    name="size"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Entry price</label>
                  <input
                    name="entry_price"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Open time</label>
                  <input
                    name="open_time"
                    type="datetime-local"
                    class="form-control"
                    step="1"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Leverage</label>
                  <input
                    name="leverage"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Liquidation price</label>
                  <input
                    name="liquidation_price"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Initial margin</label>
                  <input
                    name="initial_margin"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Notional</label>
                  <input
                    name="notional"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Fee total</label>
                  <input
                    name="fee_total"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Funding total</label>
                  <input
                    name="funding_total"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
              </form>
              <div id="manualOpenMsg" class="small text-info mt-2"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button id="btnManualOpenSave" class="btn btn-success">
                Save
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Send manual open to closed -->
      <div class="modal fade" id="modalSendClosed" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content bg-dark text-white">
            <div class="modal-header">
              <h5 class="modal-title">Send to Closed Positions</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <form id="formSendClosed" class="row g-3">
                <input type="hidden" name="manual_id" />
                <div class="col-md-6">
                  <label class="form-label">Close price</label>
                  <input
                    name="close_price"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Price PnL</label>
                  <input
                    name="pnl"
                    type="number"
                    step="any"
                    class="form-control"
                  />
                </div>
                <div class="col-md-12">
                  <label class="form-label">Close time (epoch s)</label>
                  <input name="close_time" type="number" class="form-control" />
                </div>
              </form>
              <div id="sendClosedMsg" class="small text-info mt-2"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button id="btnSendClosedSave" class="btn btn-success">
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let allFundingData = [];
      let fundingDataLoaded = false;
      let lastFundingExchangeKey = "";
      function toMs(ts) {
        if (ts === null || ts === undefined) return NaN;
        const n = Number(ts);
        if (Number.isFinite(n)) return n < 1e12 ? n * 1000 : n; // 10 d√≠gitos => s
        const d = Date.parse(ts);
        return Number.isFinite(d) ? d : NaN;
      }

      function normalizeTimestampMs(value) {
        if (value === null || value === undefined) return null;
        const n = Number(value);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n >= 1e12 ? n : n * 1000;
      }

      function cleanSymbol(sym) {
        if (!sym) return "";
        // Normalizar a may√∫sculas
        sym = sym.toUpperCase();

        // Quitar prefijo PERP_ si lo hay
        sym = sym.replace(/^PERP_/, "");

        // Quitar sufijos conocidos (USDT, USDC, PERP)
        sym = sym.replace(/(USDT|USDC|PERP)$/i, "");

        // Quitar _USDT, _USDC, -USDT, -USDC, _PERP
        sym = sym.replace(/(_|-)(USDT|USDC|PERP)$/i, "");

        // Quitar guiones bajos o medios al final
        sym = sym.replace(/[_-]+$/i, "");

        // Si todav√≠a quedan separadores, coge la primera parte "limpia"
        // Ejemplo: "KAITO_USDC" ‚Üí "KAITO", "BTC-USDC" ‚Üí "BTC"
        const parts = sym.split(/[_-]/);
        if (parts.length > 1) {
          sym = parts[0];
        }

        return sym;
      }

      // ========== OURBIT MANUAL BALANCE ==========
      function getManualOurbitBalance() {
        const stored = localStorage.getItem("ourbit_manual_balance");
        if (stored) {
          return JSON.parse(stored);
        }

        // Valores por defecto
        return {
          exchange: "ourbit",
          equity: 0,
          balance: 0,
          unrealized_pnl: 0,
          spot: 0,
          margin: 0,
          futures: 0,
        };
      }

      function saveManualOurbitBalance(data) {
        localStorage.setItem("ourbit_manual_balance", JSON.stringify(data));
      }

      function openOurbitEditModal() {
        const current = getManualOurbitBalance();

        // Crear modal din√°micamente
        const modalHtml = `
              <div class="modal fade" id="ourbitEditModal" tabindex="-1">
                  <div class="modal-dialog">
                      <div class="modal-content bg-dark text-light">
                          <div class="modal-header">
                              <h5 class="modal-title">Edit Ourbit Balances (Manual)</h5>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <div class="row g-3">
                                  <div class="col-md-6">
                                      <label class="form-label">Spot Balance</label>
                                      <input type="number" id="ourbit-spot" class="form-control bg-secondary text-light" value="${current.spot}" step="0.01" min="0">
                                  </div>
                                  <div class="col-md-6">
                                      <label class="form-label">Margin Balance</label>
                                      <input type="number" id="ourbit-margin" class="form-control bg-secondary text-light" value="${current.margin}" step="0.01" min="0">
                                  </div>
                                  <div class="col-md-6">
                                      <label class="form-label">Futures Balance</label>
                                      <input type="number" id="ourbit-futures" class="form-control bg-secondary text-light" value="${current.futures}" step="0.01" min="0">
                                  </div>
                                  <div class="col-md-6">
                                      <label class="form-label">Unrealized PnL</label>
                                      <input type="number" id="ourbit-unrealized" class="form-control bg-secondary text-light" value="${current.unrealized_pnl}" step="0.01">
                                  </div>
                              </div>
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-primary" onclick="saveOurbitBalances()">Save Changes</button>
                          </div>
                      </div>
                  </div>
              </div>
          `;

        // Remover modal existente si hay
        const existingModal = document.getElementById("ourbitEditModal");
        if (existingModal) {
          existingModal.remove();
        }

        // Agregar modal al DOM
        document.body.insertAdjacentHTML("beforeend", modalHtml);

        // Mostrar modal
        const modal = new bootstrap.Modal(
          document.getElementById("ourbitEditModal")
        );
        modal.show();
      }

      function saveOurbitBalances() {
        const spot =
          parseFloat(document.getElementById("ourbit-spot").value) || 0;
        const margin =
          parseFloat(document.getElementById("ourbit-margin").value) || 0;
        const futures =
          parseFloat(document.getElementById("ourbit-futures").value) || 0;
        const unrealized =
          parseFloat(document.getElementById("ourbit-unrealized").value) || 0;

        const equity = spot + margin + futures + unrealized;
        const balance = spot + margin + futures;

        const ourbitData = {
          exchange: "ourbit",
          equity: equity,
          balance: balance,
          unrealized_pnl: unrealized,
          spot: spot,
          margin: margin,
          futures: futures,
        };

        saveManualOurbitBalance(ourbitData);

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("ourbitEditModal")
        );
        modal.hide();

        // Recargar balances para mostrar cambios
        setTimeout(() => {
          fetch("/api/balances")
            .then((r) => r.json())
            .then((data) => {
              const exchanges = Array.isArray(data.exchanges)
                ? data.exchanges
                : [];
              let totals = data.totals || null;

              // AGREGAR OURBIT ANTES del c√°lculo de totals
              try {
                const ourbitData = getManualOurbitBalance();
                if (ourbitData) {
                  exchanges.push(ourbitData);
                }
              } catch (e) {
                console.log("‚ùå Ourbit balances error: " + e);
              }

              if (!totals) {
                totals = {
                  equity: exchanges.reduce(
                    (a, b) => a + Number(b.equity || 0),
                    0
                  ),
                  balance: exchanges.reduce(
                    (a, b) => a + Number(b.balance || 0),
                    0
                  ),
                  unrealized_pnl: exchanges.reduce(
                    (a, b) => a + Number(b.unrealized_pnl || 0),
                    0
                  ),
                };
              }

              balancesData = exchanges;
              const sortedExchanges = sortBalancesData("equity", "desc");
              renderBalancesTable({
                exchanges: sortedExchanges,
                totals: totals,
              });
            });
        }, 500);
      }

      // === FUNCI√ìN PARA CALCULAR SPREADS (ENTRY / MARK / Œî) ===
      function calculateSpread(positions) {
        if (!Array.isArray(positions) || positions.length < 2) {
          return { entry: null, mark: null, diff: null };
        }

        let longEntry = null,
          shortEntry = null,
          longMark = null,
          shortMark = null;

        positions.forEach((p) => {
          const side = (p.side || "").toLowerCase();
          const entry = Number(p.entry_price || 0);
          const mark = Number(p.mark_price || 0);

          const isLong = side === "long" || side === "spotbuy";
          const isShort = side === "short" || side === "spotsell";

          if (isLong && entry > 0) longEntry = entry;
          if (isShort && entry > 0) shortEntry = entry;

          if (isLong && mark > 0) longMark = mark;
          if (isShort && mark > 0) shortMark = mark;
        });

        const entrySpread =
          longEntry && shortEntry && shortEntry > 0
            ? ((shortEntry - longEntry) / shortEntry) * 100
            : null;
        const markSpread =
          longMark && shortMark && shortMark > 0
            ? ((shortMark - longMark) / shortMark) * 100
            : null;
        const diff =
          Number.isFinite(markSpread) && Number.isFinite(entrySpread)
            ? markSpread - entrySpread
            : null;

        return { entry: entrySpread, mark: markSpread, diff };
      }

      // === FUNCIONES PARA MODIFICAR TAMA√ëO ===
      let positionSizeCache = JSON.parse(
        localStorage.getItem("positionSizeCache") || "{}"
      );

      function saveSizeToCache(exchange, symbol, newSize) {
        const key = `${exchange.toLowerCase()}_${symbol.toUpperCase()}`;
        positionSizeCache[key] = {
          size: parseFloat(newSize),
          timestamp: Date.now(),
          symbol: symbol,
          exchange: exchange,
        };
        localStorage.setItem(
          "positionSizeCache",
          JSON.stringify(positionSizeCache)
        );
      }

      function getCachedSize(exchange, symbol, originalSize) {
        const key = `${exchange.toLowerCase()}_${symbol.toUpperCase()}`;
        const cached = positionSizeCache[key];

        // Limpiar cache si la posici√≥n ya no existe (podr√≠a expandirse con m√°s l√≥gica)
        if (cached && Date.now() - cached.timestamp > 7 * 24 * 60 * 60 * 1000) {
          delete positionSizeCache[key];
          localStorage.setItem(
            "positionSizeCache",
            JSON.stringify(positionSizeCache)
          );
          return originalSize;
        }

        return cached ? cached.size : originalSize;
      }

      function cleanupPositionCache(currentPositions) {
        const activeKeys = new Set();

        currentPositions.forEach((p) => {
          const key = `${p.exchange.toLowerCase()}_${p.symbol.toUpperCase()}`;
          activeKeys.add(key);
        });

        // Eliminar entradas de cache para posiciones que ya no existen
        Object.keys(positionSizeCache).forEach((key) => {
          if (!activeKeys.has(key)) {
            delete positionSizeCache[key];
          }
        });

        localStorage.setItem(
          "positionSizeCache",
          JSON.stringify(positionSizeCache)
        );
      }

      function renderSpread(symbol, positions) {
        const spreads = calculateSpread(positions);
        const baseId = cleanSymbol(symbol);

        const update = (id, value) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.textContent = Number.isFinite(value)
            ? `${value.toFixed(2)}%`
            : "--";
          el.classList.remove(
            "spread-positive",
            "spread-negative",
            "text-white-50"
          );
          if (!Number.isFinite(value)) {
            el.classList.add("text-white-50");
          } else {
            el.classList.add(
              value >= 0 ? "spread-positive" : "spread-negative"
            );
          }
        };

        update(`spread-entry-${baseId}`, spreads.entry);
        update(`spread-mark-${baseId}`, spreads.mark);
        update(`spread-diff-${baseId}`, spreads.diff);

        const legacy = document.getElementById(`spread-${baseId}`);
        if (legacy) {
          const fallback = Number.isFinite(spreads.diff)
            ? spreads.diff
            : spreads.entry;
          legacy.innerHTML = Number.isFinite(fallback)
            ? `<span class="${
                fallback >= 0 ? "spread-positive" : "spread-negative"
              }">${fallback.toFixed(2)}%</span>`
            : "--";
        }
      }

      function updatePositionSizeInUI(exchange, symbol, newSize) {
        // Encontrar y actualizar todas las instancias de esta posici√≥n en la UI
        const buttons = document.querySelectorAll(
          `.edit-size-btn[data-exchange="${exchange}"][data-symbol="${symbol}"]`
        );

        buttons.forEach((btn) => {
          btn.setAttribute("data-current-size", newSize);
          // Encontrar la celda de tama√±o en la misma fila y actualizarla
          const row = btn.closest("tr");
          const sizeCell = row.querySelector("td:nth-child(4)"); // Asumiendo que size es la 4ta columna
          if (sizeCell) {
            sizeCell.textContent = parseFloat(newSize).toFixed(2);
          }
        });

        // Recalcular y actualizar totales si es necesario
        setTimeout(() => {
          // Podr√≠as agregar aqu√≠ una recalculaci√≥n de los totales si es necesario
          console.log(`Size updated: ${exchange} ${symbol} -> ${newSize}`);
        }, 100);
      }

      // === BALANCES CON ORDENAMIENTO ===
      let balancesData = [];
      let currentSort = { column: "equity", direction: "desc" };

      function sortBalancesData(column, direction) {
        const sortedData = [...balancesData];

        sortedData.sort((a, b) => {
          let aVal, bVal;

          if (column === "exchange") {
            aVal = a.exchange.toUpperCase();
            bVal = b.exchange.toUpperCase();
          } else if (column === "equity") {
            aVal = parseFloat(a.equity || 0);
            bVal = parseFloat(b.equity || 0);
          } else if (column === "spot") {
            aVal = parseFloat(a.spot || 0);
            bVal = parseFloat(b.spot || 0);
          } else if (column === "margin") {
            aVal = parseFloat(a.margin || 0);
            bVal = parseFloat(b.margin || 0);
          } else if (column === "futures") {
            aVal = parseFloat(a.futures || 0);
            bVal = parseFloat(b.futures || 0);
          } else if (column === "unrealized_pnl") {
            aVal = parseFloat(a.unrealized_pnl || 0);
            bVal = parseFloat(b.unrealized_pnl || 0);
          }

          if (direction === "asc") {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
          } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
          }
        });

        return sortedData;
      }

      function renderBalancesTable(data) {
        const container = document.getElementById("balances-container");
        const totals = data.totals || {
          equity: 0,
          balance: 0,
          unrealized_pnl: 0,
        };

        // Actualizar encabezados con clases de ordenamiento
        const exchangeClass =
          currentSort.column === "exchange"
            ? `sort-${currentSort.direction}`
            : "sortable";
        const equityClass =
          currentSort.column === "equity"
            ? `sort-${currentSort.direction}`
            : "sortable";
        const spotClass =
          currentSort.column === "spot"
            ? `sort-${currentSort.direction}`
            : "sortable";
        const marginClass =
          currentSort.column === "margin"
            ? `sort-${currentSort.direction}`
            : "sortable";
        const futuresClass =
          currentSort.column === "futures"
            ? `sort-${currentSort.direction}`
            : "sortable";
        const pnlClass =
          currentSort.column === "unrealized_pnl"
            ? `sort-${currentSort.direction}`
            : "sortable";

        container.innerHTML = `
            <div class="balances-header">
            <h2>$${totals.equity.toFixed(2)}</h2>
            <div class="balances-summary">
                <div class="balance-summary-item">
                <div class="balance-summary-label">Total Balance</div>
                <div class="balance-summary-value">$${totals.balance.toFixed(
                  2
                )}</div>
                </div>
                <div class="balance-summary-item">
                <div class="balance-summary-label">Unrealized PnL</div>
                <div class="balance-summary-value ${
                  totals.unrealized_pnl >= 0
                    ? "value-positive"
                    : "value-negative"
                }">
                    $${totals.unrealized_pnl.toFixed(2)}
                </div>
                </div>
            </div>
            </div>
            
            <div class="balances-table card p-3">
            <table class="table table-sm table-bordered table-hover table-striped table-sortable">
                <thead>
                <tr>
                    <th class="${exchangeClass}" data-column="exchange">Exchange</th>
                    <th class="${spotClass}" data-column="spot">Spot</th>
                    <th class="${marginClass}" data-column="margin">Margin</th>
                    <th class="${futuresClass}" data-column="futures">Futures</th>
                    <th class="${pnlClass}" data-column="unrealized_pnl">Unrealized PnL</th>
                    <th class="${equityClass}" data-column="equity">Total Equity</th>
                </tr>
                </thead>
                <tbody>
                ${data.exchanges
                  .map(
                    (b) => `
                    <tr>
                    <td>
                      ${b.exchange.toUpperCase()}
                      ${
                        b.exchange.toLowerCase() === "ourbit"
                          ? '<button class="btn btn-sm btn-outline-warning ms-2" onclick="openOurbitEditModal()">‚úèÔ∏è Edit</button>'
                          : ""
                      }
                    </td>
                    <td>$${parseFloat(b.spot || 0).toFixed(2)}</td>
                    <td>$${parseFloat(b.margin || 0).toFixed(2)}</td>
                    <td>$${parseFloat(b.futures || 0).toFixed(2)}</td>
                    <td class="${
                      b.unrealized_pnl >= 0 ? "pnl-positive" : "pnl-negative"
                    }">
                        $${parseFloat(b.unrealized_pnl || 0).toFixed(2)}
                    </td>
                    <td>$${parseFloat(b.equity || 0).toFixed(2)}</td>
                    </tr>
                `
                  )
                  .join("")}
                </tbody>
            </table>
            </div>
        `;

        // Agregar event listeners para ordenamiento
        document
          .querySelectorAll(".table-sortable th[data-column]")
          .forEach((header) => {
            header.addEventListener("click", () => {
              const column = header.getAttribute("data-column");

              // Si ya estamos ordenando por esta columna, cambiar direcci√≥n
              if (currentSort.column === column) {
                currentSort.direction =
                  currentSort.direction === "asc" ? "desc" : "asc";
              } else {
                // Si es una columna diferente, ordenar asc por defecto excepto para equity
                currentSort.column = column;
                currentSort.direction = column === "equity" ? "desc" : "asc";
              }

              // Ordenar y volver a renderizar
              const sortedData = {
                exchanges: sortBalancesData(
                  currentSort.column,
                  currentSort.direction
                ),
                totals: totals,
              };

              renderBalancesTable(sortedData);
            });
          });
      }

      // Actualizar la llamada a la API de balances
      fetch("/api/balances")
        .then((r) => r.json())
        .then((data) => {
          const exchanges = Array.isArray(data.exchanges) ? data.exchanges : [];
          let totals = data.totals || null;

          // Ourbit (Manual) - AGREGAR ESTE BLOCO
          try {
            const ourbitData = getManualOurbitBalance();
            if (ourbitData) {
              exchanges.push(ourbitData);
            }
            console.log("‚úÖ Ourbit balances OK (Manual)");
          } catch (e) {
            console.log("‚ùå Ourbit balances error: " + e);
          }

          // SIEMPRE recalcular totales despu√©s de agregar OurBit para incluirlo en el total
          totals = {
            equity: exchanges.reduce((a, b) => a + Number(b.equity || 0), 0),
            balance: exchanges.reduce((a, b) => a + Number(b.balance || 0), 0),
            unrealized_pnl: exchanges.reduce(
              (a, b) => a + Number(b.unrealized_pnl || 0),
              0
            ),
          };

          // Guardar datos originales
          balancesData = exchanges;

          // Ordenar por defecto por equity descendente
          const sortedExchanges = sortBalancesData("equity", "desc");

          // Renderizar tabla
          renderBalancesTable({
            exchanges: sortedExchanges,
            totals: totals,
          });
        });

      // --- HELPERS FUNDING PARA OPEN POSITIONS ---
      function ymd(d) {
        // YYYY-MM-DD en local
        const z = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
        return z.toISOString().slice(0, 10);
      }

      // Suma funding (income) de allFundingData para un s√≠mbolo base en un d√≠a concreto (YYYY-MM-DD)
      function sumFundingForDay(baseSym, ymdStr) {
        if (
          !Array.isArray(window.allFundingData) ||
          !window.allFundingData.length
        )
          return 0;
        let s = 0;
        for (const f of window.allFundingData) {
          // ‚¨áÔ∏è ignora proyecciones/estimaciones
          if (
            f?.estimated ||
            String(f?.type).toUpperCase() === "FUNDING_ESTIMATE"
          )
            continue;

          const d = f?.timestamp ? new Date(f.timestamp) : null;
          if (!d) continue;
          if (ymd(d) !== ymdStr) continue;
          if (cleanSymbol(f.symbol) !== baseSym) continue;
          s += Number(f.income || 0);
        }
        return s;
      }

      // Devuelve {d2, d1, d0} para la cabecera
      function fundingLast3Days(baseSym) {
        const now = new Date();
        const d0 = ymd(now);
        const d1 = ymd(
          new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1)
        );
        const d2 = ymd(
          new Date(now.getFullYear(), now.getMonth(), now.getDate() - 2)
        );
        return {
          d2: sumFundingForDay(baseSym, d2),
          d1: sumFundingForDay(baseSym, d1),
          d0: sumFundingForDay(baseSym, d0),
        };
      }

      // Formatea + colorea importes
      function fmtFundingVal(x) {
        const n = Number(x || 0);
        const cls = n >= 0 ? "pnl-positive" : "pnl-negative";
        return `<span class="${cls}">${n.toFixed(2)}</span>`;
      }

      // Calcula APR neto (LIVE) a partir de las patas del grupo, si vienen rate e intervalo
      // Convenci√≥n: rate viene como fracci√≥n por intervalo (ej. 0.01% => 0.0001), intervalo en horas (1/4/8).
      // Long paga (+rate => -), Short cobra (+rate => +). Net = sum(sign*rate)* (24/interval) * 365 * 100
      function calcNetFundingAPR(positions) {
        if (!Array.isArray(positions) || !positions.length) return null;
        let acc = 0;
        for (const p of positions) {
          const rate = Number(p?.funding_rate);
          const ih = Number(
            p?.funding_interval_hours || p?.funding_interval_h || 0
          );
          if (!Number.isFinite(rate) || !Number.isFinite(ih) || ih <= 0)
            return null;
          const side = (p?.side || "").toLowerCase();
          const sign = side === "short" ? +1 : side === "long" ? -1 : 0;
          acc += sign * rate * (24 / ih);
        }
        // anualizado en %
        return acc * 365 * 100;
      }

      // === OPEN POSITIONS ===
      function fmt(x, d = 4) {
        const n = Number(x);
        return Number.isFinite(n) ? n.toFixed(d) : "";
      }
      function riskClass(pct) {
        if (!Number.isFinite(pct)) return "";
        if (pct <= 10) return "risk-red";
        if (pct <= 20) return "risk-orange";
        if (pct <= 35) return "risk-yellow";
        return "risk-green";
      }

      function formatNumber(value, decimals = 2) {
        const n = Number(value);
        if (!Number.isFinite(n)) return (0).toFixed(decimals);
        return n.toLocaleString("en-US", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        });
      }
      // Render helper to (re)draw open positions from rows
      function renderOpenPositionsFromRows(rows) {
        const container = document.getElementById("positions-container");
        if (!container) return;
        container.innerHTML = "";

        const list = Array.isArray(rows) ? rows : [];

        // Limpiar cache de posiciones cerradas
        cleanupPositionCache(list);

        // Agrupar por s√≠mbolo base
        const grouped = {};
        list.forEach((p) => {
          const sym = cleanSymbol(p.symbol);
          if (!grouped[sym]) grouped[sym] = [];
          grouped[sym].push(p);
        });

        Object.entries(grouped).forEach(([symbol, positions]) => {
          const baseSym = cleanSymbol(symbol);
          const now = new Date();
          const d0 = ymd(now);
          const d1 = ymd(
            new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1)
          );
          const d2 = ymd(
            new Date(now.getFullYear(), now.getMonth(), now.getDate() - 2)
          );
          const f3 = {
            d0: sumFundingForDay(baseSym, d0),
            d1: sumFundingForDay(baseSym, d1),
            d2: sumFundingForDay(baseSym, d2),
          };
          const usesWs = positions.some(
            (row) => (row?.data_source || "").toLowerCase() === "ws"
          );

          // Encontrar la posici√≥n m√°s reciente (mayor open_time)
          const mostRecent = positions.reduce((latest, current) => {
            const latestTime = Number(latest?.open_time || 0);
            const currentTime = Number(current?.open_time || 0);
            return currentTime > latestTime ? current : latest;
          }, positions[0]);

          const openTimeFormatted = (() => {
            const tsMs = normalizeTimestampMs(mostRecent?.open_time);
            if (!tsMs) return "-";
            const d = new Date(tsMs);
            const dd = String(d.getDate()).padStart(2, "0");
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const yyyy = d.getFullYear();
            const hh = String(d.getHours()).padStart(2, "0");
            const min = String(d.getMinutes()).padStart(2, "0");
            return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
          })();

          let card = `
            <div class="strategy-card" data-symbol="${baseSym}" data-exchange="${
            positions[0]?.exchange || ""
          }">
            <div class="strategy-header">
              <div class="d-flex w-100 justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex align-items-center gap-3">
                  <h5 class="mb-0">
                    ${cleanSymbol(symbol)}
                    ${
                      usesWs
                        ? '<span class="badge bg-info text-dark ms-1">WS</span>'
                        : ""
                    }
                  </h5>
                  ${
                    positions.length > 1
                      ? `
                  <div class="header-spread-grid">
                    <div class="spread-box">
                      <div class="spread-label">Entry</div>
                      <div class="spread-value" id="spread-entry-${cleanSymbol(
                        symbol
                      )}">--</div>
                    </div>
                    <div class="spread-box">
                      <div class="spread-label">Mark</div>
                      <div class="spread-value" id="spread-mark-${cleanSymbol(
                        symbol
                      )}">--</div>
                    </div>
                    <div class="spread-box">
                      <div class="spread-label">Difference</div>
                      <div class="spread-value" id="spread-diff-${cleanSymbol(
                        symbol
                      )}">--</div>
                    </div>
                    <span class="badge bg-warning text-dark">DN</span>
                  </div>
                  `
                      : ""
                  }
                  <span id="spread-${cleanSymbol(
                    symbol
                  )}" class="d-none">-</span>
                </div>
                <div class="d-flex gap-2 small flex-wrap justify-content-end align-items-center">
                  <div><span class="text-white-50">Opened:</span> <span class="text-info">${openTimeFormatted}</span></div>
                  <div class="vr" style="opacity: 0.3;"></div>
                  <div><span class="text-white-50">Funding D-2:</span> <span class="funding-d2 metric-value-sm" data-exchange="${
                    positions[0]?.exchange || ""
                  }" data-symbol="${baseSym}">${fmtFundingVal(
            f3.d2
          )}</span></div>
                  <div><span class="text-white-50">D-1:</span> <span class="funding-d1 metric-value-sm" data-exchange="${
                    positions[0]?.exchange || ""
                  }" data-symbol="${baseSym}">${fmtFundingVal(
            f3.d1
          )}</span></div>
                  <div><span class="text-white-50">Hoy:</span> <span class="funding-today metric-value-sm" data-exchange="${
                    positions[0]?.exchange || ""
                  }" data-symbol="${baseSym}">${fmtFundingVal(
            f3.d0
          )}</span></div>
                </div>
              </div>
            </div>

            <table class="table table-sm table-bordered table-hover">
              <thead>
                <tr>
                  <th>Exchange</th><th>Symbol</th><th>Side</th><th>Size</th>
                  <th>Entry</th><th>Mark</th><th>Liq.</th>
                  <th>Inc. to Liq</th><th>Closed %</th><th>Init. Margin</th><th>Margin</th>
                  <th>Notional</th><th>Funding rate</th>
                  <th>Interval</th><th>Unrealized PnL</th><th>Fee</th>
                  <th>Funding Fee</th><th>Realized PnL</th>
                  <th>Edit</th>
                </tr>
              </thead>
              <tbody>`;

          let totalNotional = 0,
            totalMargin = 0,
            sizeLong = 0,
            sizeShort = 0,
            unrealizedTotal = 0,
            realizedTotal = 0;

          positions.forEach((p) => {
            const side = (p?.side || "").toLowerCase();
            const sideLabel = side ? side.toUpperCase() : "-";
            const originalSize = Number(p?.size || 0);
            const cachedSize = getCachedSize(
              p?.exchange || "",
              p?.symbol || "",
              originalSize
            );
            const displaySize = cachedSize;
            const entry = Number(p?.entry_price || 0);
            const mark = Number(p?.mark_price || 0);
            const liq = Number(p?.liquidation_price || 0);
            const notional = Number(
              p?.notional || (mark > 0 ? Math.abs(displaySize * mark) : 0)
            );
            const sourceBadge =
              (p?.data_source || "").toLowerCase() === "ws"
                ? '<span class="badge bg-info text-dark ms-1">WS</span>'
                : "";

            totalNotional += notional;
            totalMargin += Number(p?.margin || 0);
            unrealizedTotal += Number(p?.unrealized_pnl || 0);
            realizedTotal += Number(p?.realized_pnl || 0);
            if (side === "long") sizeLong += displaySize;
            if (side === "short") sizeShort += displaySize;

            const incToLiqPct =
              mark > 0 && liq > 0 ? (Math.abs(mark - liq) / mark) * 100 : null;
            const initSize = Number(
              p?.initial_size ??
                Number(p?.size || 0) + Number(p?.closed_size || 0)
            );
            const closedSize = Number(p?.closed_size || 0);
            const closedPct =
              initSize > 0 ? (100 * closedSize) / initSize : null;

            card += `
              <tr>
                <td>${p?.exchange || ""}${sourceBadge}</td>
                <td>${cleanSymbol(p?.symbol)}</td>
                <td><span class="badge ${
                  side === "long"
                    ? "badge-long"
                    : side === "short"
                    ? "badge-short"
                    : "bg-secondary"
                }">${sideLabel}</span></td>
                <td>${fmt(displaySize, 2)}</td>
                <td>${fmt(entry)}</td>
                <td>${fmt(mark)}</td>
                <td>${fmt(liq)}</td>
                <td>${
                  incToLiqPct === null
                    ? "-"
                    : `<span class="risk-pill ${riskClass(
                        incToLiqPct
                      )}">${incToLiqPct.toFixed(1)}%</span>`
                }</td>
                <td>${
                  closedPct === null ? "-" : closedPct.toFixed(1) + "%"
                }</td>
                <td>$${fmt(p?.init_margin ?? 0, 2)}</td>
                <td>$${fmt(p?.main_margin ?? 0, 2)}</td>
                <td>$${fmt(notional, 2)}</td>
                <td>${
                  (p?.funding_rate ?? "") === ""
                    ? "-"
                    : (Number(p.funding_rate) * 100).toFixed(4) + "%"
                }</td>
                <td>${
                  p?.funding_interval_hours ?? p?.funding_interval_h ?? "-"
                }</td>
                <td class="${
                  (Number(p?.unrealized_pnl) || 0) >= 0
                    ? "pnl-positive"
                    : "pnl-negative"
                }">$${fmt(p?.unrealized_pnl, 2)}</td>
                <td class="${
                  (Number(p?.fee) || 0) >= 0 ? "pnl-positive" : "pnl-negative"
                }">$${fmt(p?.fee, 2)}</td>
                <td class="${
                  (Number(p?.funding_fee) || 0) >= 0
                    ? "pnl-positive"
                    : "pnl-negative"
                }">$${fmt(p?.funding_fee, 2)}</td>
                <td class="${
                  (Number(p?.realized_pnl) || 0) >= 0
                    ? "pnl-positive"
                    : "pnl-negative"
                }">$${fmt(p?.realized_pnl, 2)}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary"
                          onclick='openEditModal(${JSON.stringify(p)})'>
                    ‚úèÔ∏è
                  </button>
                  ${
                    p?._source === "manual" || !!p?.manual_id
                      ? `
                    <button class="btn btn-sm btn-outline-danger btn-sm" data-action="del" data-id="${
                      p?.manual_id || ""
                    }">üóë</button>
                    <button class="btn btn-sm btn-outline-success btn-sm" data-action="send" data-id="${
                      p?.manual_id || ""
                    }">‚Üí</button>
                  `
                      : ""
                  }
                </td>
              </tr>`;
          });

          card += `</tbody></table>
            <div class="summary-grid">
              <div class="summary-item"><h6>Total Notional</h6><p>$${fmt(
                totalNotional,
                2
              )}</p></div>
              <div class="summary-item"><h6>Total Margin</h6><p>$${fmt(
                totalMargin,
                2
              )}</p></div>
              <div class="summary-item"><h6>Size Long</h6><p>${fmt(
                sizeLong,
                2
              )}</p></div>
              <div class="summary-item"><h6>Size Short</h6><p>${fmt(
                sizeShort,
                2
              )}</p></div>
              <div class="summary-item"><h6>Net Exposure</h6><p>${fmt(
                sizeLong - sizeShort,
                2
              )}</p></div>
              <div class="summary-item">
                <h6>FR APR</h6>
                <p>${(() => {
                  const v = calcNetFundingAPR(positions);
                  return v === null ? "-" : v.toFixed(2) + "%";
                })()}</p>
              </div>
              <div class="summary-item">
                <h6>FR Position APR</h6>
                <p>${
                  positions?.[0]?.group_funding_position_apr ??
                  positions?.group_funding_position_apr ??
                  "-"
                }</p>
              </div>
              <div class="summary-item"><h6>Unrealized PnL</h6><p class="${
                unrealizedTotal >= 0 ? "pnl-positive" : "pnl-negative"
              }">$${fmt(unrealizedTotal, 2)}</p></div>
              <div class="summary-item"><h6>Realized PnL</h6><p class="${
                realizedTotal >= 0 ? "pnl-positive" : "pnl-negative"
              }">$${fmt(realizedTotal, 2)}</p></div>
            </div>
          </div>`;

          container.innerHTML += card;
          renderSpread(symbol, positions);
        });
      }

      // (Deprecated) Old edit-size listeners removed to avoid null element errors

      // (Deprecated) Removed experimental renderPositions and duplicate helpers to fix parse errors

      // === FUNDING FEES CON PAGINACI√ìN ===

      let currentPage = 1;
      let itemsPerPage = 7; // Por defecto √∫ltimos 7 d√≠as

      function loadFundingData(options = {}) {
        const { force = false, exchangesOverride = null } = options;
        const exchanges =
          Array.isArray(exchangesOverride) && exchangesOverride.length
            ? exchangesOverride
            : getSelectedExchanges();
        const key = exchanges.slice().sort().join(",") || "__all__";

        if (
          !force &&
          fundingDataLoaded &&
          key === lastFundingExchangeKey &&
          allFundingData.length
        ) {
          return Promise.resolve(allFundingData);
        }

        const params = new URLSearchParams();
        if (exchanges.length) {
          params.set("exchanges", exchanges.join(","));
        }
        if (force) {
          params.set("refresh", "1");
        }

        const qs = params.toString();

        return fetch(`/api/funding${qs ? `?${qs}` : ""}`)
          .then((r) => r.json())
          .then((data) => {
            // ‚¨áÔ∏è normalizamos 'timestamp' y 'symbol' para TODOS los adapters
            allFundingData = (data.funding || [])
              .map((f) => {
                const ts = toMs(f.timestamp ?? f.created_at ?? f.time);
                const sym =
                  f.symbol || f.market || f.instId || f.instrument || "";
                const inc = Number(f.income ?? f.funding_fee ?? 0);
                return { ...f, timestamp: ts, symbol: sym };
              })
              .filter((f) => Number.isFinite(f.timestamp)); // quitamos filas sin fecha v√°lida

            // orden m√°s reciente primero
            allFundingData.sort((a, b) => b.timestamp - a.timestamp);
            fundingDataLoaded = true;
            lastFundingExchangeKey = key;
            applyDaysFilter();
            updateFundingForOpenPositions();
          })
          .catch((err) => {
            console.error("‚ùå Error loading funding fees:", err);
            document.getElementById("funding-container").innerHTML =
              "<p>Error loading funding fees</p>";
          });
      }

      function applyDaysFilter() {
        const days = parseInt(document.getElementById("daysSelector").value);
        const showEst =
          document.getElementById("toggleEstimates")?.checked !== false;

        let filteredData = allFundingData.slice();

        if (!showEst) {
          filteredData = filteredData.filter(
            (f) => !f.estimated && f.type !== "FUNDING_ESTIMATE"
          );
        }

        if (days > 0) {
          const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
          filteredData = filteredData.filter(
            (f) => Number(f.timestamp) >= cutoff
          );
        }

        renderFundingPagination(filteredData);
      }
      document
        .getElementById("toggleEstimates")
        ?.addEventListener("change", applyDaysFilter);

      function renderFundingPagination(filteredData) {
        // Agrupar por d√≠a (YYYY-MM-DD)
        const grouped = {};
        filteredData.forEach((f) => {
          const day = f.timestamp
            ? new Date(f.timestamp).toISOString().split("T")[0]
            : "Unknown";
          if (!grouped[day]) grouped[day] = [];
          grouped[day].push(f);
        });

        // Convertir a array y ordenar por fecha descendente
        const daysArray = Object.entries(grouped)
          .sort((a, b) => new Date(b[0]) - new Date(a[0]))
          .map(([day, rows]) => ({ day, rows }));

        const totalPages = Math.ceil(daysArray.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentDays = daysArray.slice(startIndex, endIndex);

        // Renderizar contenido
        renderFundingContent(currentDays);

        // Renderizar paginaci√≥n
        renderPaginationControls(totalPages);
      }

      function renderFundingContent(days) {
        const container = document.getElementById("funding-container");

        if (days.length === 0) {
          container.innerHTML =
            "<p>No funding data available for the selected period.</p>";
          return;
        }

        let html = "";
        days.forEach(({ day, rows }) => {
          html += `
            <div class="strategy-card">
              <div class="strategy-header">
                <h5>${day}</h5>
                <p>
                  Total Funding: 
                  <span class="${
                    rows.reduce((sum, f) => sum + (f.income || 0), 0) >= 0
                      ? "pnl-positive"
                      : "pnl-negative"
                  }">
                    ${rows
                      .reduce((sum, f) => sum + (f.income || 0), 0)
                      .toFixed(2)}
                  </span>
                </p>
              </div>
              <table class="table table-sm table-bordered table-hover table-striped">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Exchange</th>
                    <th>Symbol</th>
                    <th>Income</th>
                    <th>Asset</th>
                  </tr>
                </thead>
                <tbody>
                    ${rows
                      .map((f) => {
                        const isEst = !!(
                          f.estimated || f.type === "FUNDING_ESTIMATE"
                        );
                        const cls =
                          (f.income || 0) >= 0
                            ? "pnl-positive"
                            : "pnl-negative";
                        const amt = (f.income || 0).toFixed(2);
                        return `
                        <tr class="${isEst ? "funding-estimate" : ""}">
                        <td>${
                          f.timestamp
                            ? new Date(f.timestamp).toLocaleTimeString()
                            : ""
                        }</td>
                        <td>${f.exchange}</td>
                        <td>${cleanSymbol(f.symbol)}</td>
                        <td class="${cls}">${isEst ? "‚âà " : ""}${amt}</td>
                        <td>${f.asset}</td>
                        </tr>`;
                      })
                      .join("")}
                </tbody>
              </table>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      function renderPaginationControls(totalPages) {
        const paginationTop = document.getElementById("fundingPagination");
        const paginationBottom = document.getElementById(
          "fundingPaginationBottom"
        );

        if (totalPages <= 1) {
          paginationTop.innerHTML = "";
          paginationBottom.innerHTML = "";
          return;
        }

        const paginationHTML = `
          <button class="page-btn" onclick="changePage(1)" ${
            currentPage === 1 ? "disabled" : ""
          }>
            First
          </button>
          <button class="page-btn" onclick="changePage(${currentPage - 1})" ${
          currentPage === 1 ? "disabled" : ""
        }>
            Previous
          </button>
          <span style="color: #e8e8e8; margin: 0 10px;">
            Page ${currentPage} of ${totalPages}
          </span>
          <button class="page-btn" onclick="changePage(${currentPage + 1})" ${
          currentPage === totalPages ? "disabled" : ""
        }>
            Next
          </button>
          <button class="page-btn" onclick="changePage(${totalPages})" ${
          currentPage === totalPages ? "disabled" : ""
        }>
            Last
          </button>
        `;

        paginationTop.innerHTML = paginationHTML;
        paginationBottom.innerHTML = paginationHTML;
      }

      function changePage(page) {
        const days = parseInt(document.getElementById("daysSelector").value);
        const showEst =
          document.getElementById("toggleEstimates")?.checked !== false;

        let filteredData = allFundingData.slice();
        if (!showEst)
          filteredData = filteredData.filter(
            (f) => !f.estimated && f.type !== "FUNDING_ESTIMATE"
          );
        if (days > 0) {
          const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
          filteredData = filteredData.filter(
            (f) => Number(f.timestamp) >= cutoff
          );
        }

        // re-agrupa y calcula totalPages igual que ahora...
        const grouped = {};
        filteredData.forEach((f) => {
          const day = new Date(f.timestamp).toISOString().split("T")[0];
          (grouped[day] ??= []).push(f);
        });

        const daysArray = Object.entries(grouped)
          .sort((a, b) => new Date(b[0]) - new Date(a[0]))
          .map(([day, rows]) => ({ day, rows }));

        const totalPages = Math.ceil(daysArray.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          renderFundingPagination(filteredData);
        }
      }

      // Cargar funding fees cuando se muestre la pesta√±a
      document
        .getElementById("funding-tab")
        ?.addEventListener("shown.bs.tab", function () {
          if (!fundingDataLoaded) {
            loadFundingData();
          }
        });

      // Event listeners
      document
        .getElementById("daysSelector")
        .addEventListener("change", function () {
          currentPage = 1;
          applyDaysFilter();
        });

      document
        .getElementById("refreshFunding")
        .addEventListener("click", function () {
          loadFundingData({ force: true });
        });

      // === CLOSED POSITIONS ===
      function pricePnlFromRow(p) {
        // Usa el que viene de la DB/API (FIFO)
        const v = p && (p.pnl ?? p.price_pnl);
        if (v !== undefined && v !== null && !Number.isNaN(Number(v))) {
          return Number(v);
        }
        // Fallback simple si no viniera pnl
        const side = (p.side || "").toLowerCase();
        const entry = Number(p.entry_price || 0);
        const close = Number(p.close_price || 0);
        const size = Number(p.size || 0);
        return side === "short"
          ? (entry - close) * size
          : (close - entry) * size;
      }

      function summarizeGroupFromRows(rows) {
        return rows.reduce(
          (acc, p) => {
            const pnl = pricePnlFromRow(p);
            const fees = Number(p.fees ?? p.fee_total ?? 0);
            const funding = Number(p.funding_fee ?? p.funding_total ?? 0);
            const realized = Number(p.realized_pnl ?? 0);
            const margin = marginFromRow(p);

            acc.pnl += pnl;
            acc.fees += fees;
            acc.funding += funding;
            acc.realized += realized;
            acc.margin += margin;
            return acc;
          },
          { pnl: 0, fees: 0, funding: 0, realized: 0, margin: 0 }
        );
      }

      function marginFromRow(p) {
        // Preferir campos del backend si existen
        const m = p?.margin ?? p?.initial_margin ?? p?.isolated_margin;
        if (m !== undefined && m !== null && Number.isFinite(Number(m))) {
          return Number(m);
        }
        // Fallback: size * entry / leverage (si hay leverage)
        const size = Number(p?.size ?? 0);
        const entry = Number(p?.entry_price ?? 0);
        const lev = Number(p?.leverage ?? 0);
        if (lev > 0) return (Math.abs(size) * entry) / lev;

        // √öltimo recurso: 0
        return 0;
      }

      function pnlPctFromRow({ pnl, fees, funding, realized, margin }) {
        // ROI sobre margen: (pnl + funding + realized + fees) / margin
        const total =
          Number(pnl) + Number(funding) + Number(realized) + Number(fees);
        if (!margin || !Number.isFinite(margin) || margin === 0) return null;
        return (total / margin) * 100;
      }

      function aprFromRow({ pnlPct, openTs, closeTs }) {
        if (pnlPct === null || pnlPct === undefined) return null;
        const ot = Number(openTs);
        const ct = Number(closeTs);
        // open_date/close_date tambi√©n pueden venir como ISO; si no son num√©ricos, intentamos Date.parse
        const openMs = Number.isFinite(ot)
          ? ot * 1000
          : Date.parse(openTs) || NaN;
        const closeMs = Number.isFinite(ct)
          ? ct * 1000
          : Date.parse(closeTs) || NaN;
        if (
          !Number.isFinite(openMs) ||
          !Number.isFinite(closeMs) ||
          closeMs <= openMs
        )
          return null;
        const days = (closeMs - openMs) / (1000 * 60 * 60 * 24);
        if (days <= 0) return null;
        return pnlPct * (365 / days);
      }

      function tsToStr(ts) {
        if (!ts) return "";
        // soporta tanto open_date/close_date string como open_time/close_time en segundos
        if (typeof ts === "string" && ts.includes("T"))
          return ts.replace("T", " ").replace("Z", "");
        const n = Number(ts);
        return Number.isFinite(n) ? new Date(n * 1000).toLocaleString() : "";
      }

      // === CLOSED TOTALS (Realized PnL) ===
      function _closeTsMsFromRow(p) {
        // usa close_time (s o ms) o close_date ISO
        const raw = p?.close_time ?? p?.close_date;
        return toMs(raw); // usa tu helper existente
      }

      function _realizedFromRow(p) {
        const v = Number(p?.realized_pnl ?? 0);
        return Number.isFinite(v) ? v : 0;
      }

      function _flattenClosed(list) {
        // Soporta formato agrupado { positions:[...] } o filas planas
        const out = [];
        for (const g of list || []) {
          if (Array.isArray(g.positions) && g.positions.length) {
            out.push(...g.positions);
          } else {
            out.push(g);
          }
        }
        return out;
      }

      function renderClosedTotals(list) {
        const rows = _flattenClosed(list);
        const now = Date.now();
        const d7 = now - 7 * 24 * 3600 * 1000;
        const d30 = now - 30 * 24 * 3600 * 1000;

        let sumAll = 0,
          sum7 = 0,
          sum30 = 0;

        for (const p of rows) {
          const r = _realizedFromRow(p);
          const ct = _closeTsMsFromRow(p);
          sumAll += r;
          if (Number.isFinite(ct)) {
            if (ct >= d7) sum7 += r;
            if (ct >= d30) sum30 += r;
          }
        }

        const el = document.getElementById("closedTotals");
        if (!el) return;

        const item = (label, val) => `
        <div class="header-summary-item">
            <div class="header-summary-label">${label}</div>
            <div class="header-summary-value ${
              val >= 0 ? "text-success" : "text-danger"
            }">
            $${val.toFixed(2)}
            </div>
        </div>`;

        el.innerHTML = `
        ${item("Realized (All)", sumAll)}
        ${item("Realized (7d)", sum7)}
        ${item("Realized (30d)", sum30)}
    `;
      }

      // === CLOSED POSITIONS CON FILTROS Y PAGINACI√ìN ===
      let closedPositionsData = [];
      let currentClosedPage = 1;
      let closedPageSize = 10;
      let closedFilters = {
        exchange: "",
        symbol: "",
        side: "",
        date: "2025-09-01",
      };

      // Funci√≥n para aplicar filtros a los datos de closed positions
      function applyClosedFilters() {
        let filtered = closedPositionsData;

        // Filtro por exchange
        if (closedFilters.exchange) {
          filtered = filtered.filter((group) => {
            // Comprobamos si alguna posici√≥n en el grupo tiene el exchange que coincide
            return group.positions.some((p) =>
              p.exchange
                .toLowerCase()
                .includes(closedFilters.exchange.toLowerCase())
            );
          });
        }

        // Filtro por symbol
        if (closedFilters.symbol) {
          filtered = filtered.filter((group) => {
            return group.positions.some((p) =>
              cleanSymbol(p.symbol)
                .toLowerCase()
                .includes(closedFilters.symbol.toLowerCase())
            );
          });
        }

        // Filtro por side
        if (closedFilters.side) {
          filtered = filtered.filter((group) => {
            return group.positions.some(
              (p) => p.side.toUpperCase() === closedFilters.side
            );
          });
        }

        // Filtro por fecha (a partir del 1 de septiembre de 2025)
        if (closedFilters.date) {
          const filterDate = new Date(closedFilters.date);
          filtered = filtered.filter((group) => {
            const closeDate = new Date(group.close_date || group.close_time);
            return closeDate >= filterDate;
          });
        }

        return filtered;
      }

      // Funci√≥n para renderizar la paginaci√≥n de closed positions
      function renderClosedPagination(filteredData) {
        const totalPages = Math.ceil(filteredData.length / closedPageSize);
        const paginationTop = document.getElementById("closedPaginationTop");
        const paginationBottom = document.getElementById(
          "closedPaginationBottom"
        );
        const startItem = (currentClosedPage - 1) * closedPageSize + 1;
        const endItem = Math.min(
          currentClosedPage * closedPageSize,
          filteredData.length
        );

        const paginationHTML = `
        <div class="closed-pagination-info me-3">
            Showing ${startItem} to ${endItem} of ${filteredData.length} entries
        </div>
        <button class="page-btn" onclick="changeClosedPage(1)" ${
          currentClosedPage === 1 ? "disabled" : ""
        }>
            First
        </button>
        <button class="page-btn" onclick="changeClosedPage(${
          currentClosedPage - 1
        })" ${currentClosedPage === 1 ? "disabled" : ""}>
            Previous
        </button>
        <span style="color: #e8e8e8; margin: 0 10px;">
            Page ${currentClosedPage} of ${totalPages}
        </span>
        <button class="page-btn" onclick="changeClosedPage(${
          currentClosedPage + 1
        })" ${currentClosedPage === totalPages ? "disabled" : ""}>
            Next
        </button>
        <button class="page-btn" onclick="changeClosedPage(${totalPages})" ${
          currentClosedPage === totalPages ? "disabled" : ""
        }>
            Last
        </button>
    `;

        if (paginationTop) paginationTop.innerHTML = paginationHTML;
        if (paginationBottom) paginationBottom.innerHTML = paginationHTML;
      }

      // Funci√≥n para cambiar de p√°gina en closed positions
      function changeClosedPage(page) {
        const filteredData = applyClosedFilters();
        const totalPages = Math.ceil(filteredData.length / closedPageSize);

        if (page < 1 || page > totalPages) return;

        currentClosedPage = page;
        renderClosedPositions(filteredData);
      }

      // Funci√≥n para renderizar las posiciones cerradas (con paginaci√≥n)
      function renderClosedPositions(data) {
        const container = document.getElementById("closedPositions");
        if (!container) return;

        container.innerHTML = "";

        const filteredData = applyClosedFilters();
        const totalPages = Math.ceil(filteredData.length / closedPageSize);
        const startIndex = (currentClosedPage - 1) * closedPageSize;
        const endIndex = startIndex + closedPageSize;
        const currentData = filteredData.slice(startIndex, endIndex);

        renderClosedPagination(filteredData);

        if (currentData.length === 0) {
          container.innerHTML =
            '<p class="text-muted">No closed positions found.</p>';
          return;
        }

        currentData.forEach((group) => {
          const rows =
            Array.isArray(group.positions) && group.positions.length
              ? group.positions
              : [group];

          const baseSymbol = cleanSymbol(rows[0]?.symbol || group.symbol || "");
          const openStr = group.open_date || tsToStr(group.open_time);
          const closeStr = group.close_date || tsToStr(group.close_time);

          // Contar LONG/SHORT para badge DN
          let longCount = 0,
            shortCount = 0;

          const rowsHtml = rows
            .map((p) => {
              let sideLabel = (p.side || "").toUpperCase();
              if (sideLabel === "CLOSED") {
                sideLabel =
                  Number(p.close_price) >= Number(p.entry_price)
                    ? "LONG"
                    : "SHORT";
                // ‚úÖ DN counting: SPOTBUY como LONG, SPOTSELL como SHORT
                if (sideLabel === "LONG" || sideLabel === "SPOTBUY")
                  longCount++;
                if (sideLabel === "SHORT" || sideLabel === "SPOTSELL")
                  shortCount++;
              }
              // Tratar SPOTBUY como LONG para delta neutral
              if (sideLabel === "LONG" || sideLabel === "SPOTBUY") longCount++;
              if (sideLabel === "SHORT") shortCount++;

              const pnl = pricePnlFromRow(p);
              const pnlClass = pnl >= 0 ? "text-success" : "text-danger";

              const feeVal = Number(p.fees ?? p.fee_total ?? 0);
              const fundingVal = Number(p.funding_fee ?? p.funding_total ?? 0);
              const realizedVal = Number(p.realized_pnl ?? 0);
              const feeClass = feeVal < 0 ? "text-danger" : "text-success";
              const fundingClass =
                fundingVal < 0 ? "text-danger" : "text-success";
              const realizedClass =
                realizedVal >= 0 ? "text-success" : "text-danger";

              // NUEVOS CAMPOS
              const marginVal = marginFromRow(p);
              const pnlPctVal = pnlPctFromRow({
                pnl,
                fees: feeVal,
                funding: fundingVal,
                realized: realizedVal,
                margin: marginVal,
              });

              const aprVal = aprFromRow({
                pnlPct: pnlPctVal,
                openTs: p.open_time ?? p.open_date,
                closeTs: p.close_time ?? p.close_date,
              });

              return `
                <tr>
                    <td><input type="checkbox" class="closed-pos-checkbox" data-id="${
                      p.id || 0
                    }"></td>
                    <td>${p.exchange}</td>
                    <td>${cleanSymbol(p.symbol)}</td>
                    <td>
                    <span class="badge ${
                      sideLabel === "LONG" || sideLabel === "SPOTBUY"
                        ? "bg-success"
                        : sideLabel === "SWAPSTABLE"
                        ? "bg-info"
                        : "bg-danger"
                    } compact-badge">${sideLabel}</span>
                    </td>
                    <td>${Number(p.size).toFixed(2)}</td>
                    <td>${Number(p.entry_price).toFixed(4)}</td>
                    <td>${Number(p.close_price).toFixed(4)}</td>
                    <td>$${Number(marginVal || 0).toFixed(2)}</td>
                    <td class="${pnlClass} fw-bold" title="FIFO (DB)">$${pnl.toFixed(
                2
              )}</td>
                    <td class="${feeClass} fw-bold">$${feeVal.toFixed(2)}</td>
                    <td class="${fundingClass} fw-bold">$${fundingVal.toFixed(
                2
              )}</td>
                    <td class="${realizedClass} fw-bold">$${realizedVal.toFixed(
                2
              )}</td>
                    <td>${
                      pnlPctVal === null ? "-" : pnlPctVal.toFixed(2) + "%"
                    }</td>
                    <td>${aprVal === null ? "-" : aprVal.toFixed(2) + "%"}</td>
                </tr>`;
            })
            .join("");

          const totals = summarizeGroupFromRows(rows);
          const dn = longCount > 0 && shortCount > 0;
          const dnBadge = dn
            ? '<span class="badge bg-warning text-dark compact-badge ms-2">DELTA NEUTRAL</span>'
            : "";

          container.innerHTML += `
            <div class="closed-position-card">
                <div class="closed-position-header">
                    <!-- IZQUIERDA: s√≠mbolo + DN + fechas en l√≠nea -->
                    <div class="d-flex align-items-center gap-2 flex-wrap flex-grow-1">
                    <h6 class="mb-0">${baseSymbol} ${dnBadge}</h6>
                    <span class="pos-dates small text-white-50">
                        ${openStr ? `${openStr} &rarr; ` : ""}${closeStr || ""}
                    </span>
                    </div>

                    <!-- DERECHA: TOTALES (se quedan arriba a la derecha) -->
                    <div class="header-summary d-flex align-items-center gap-3">
                    <div class="header-summary-item">
                        <div class="header-summary-label">Total PnL</div>
                        <div class="header-summary-value ${
                          totals.pnl >= 0 ? "text-success" : "text-danger"
                        }" title="FIFO (DB)">
                        $${totals.pnl.toFixed(2)}
                        </div>
                    </div>
                    <div class="header-summary-item">
                        <div class="header-summary-label">Total Fees</div>
                        <div class="header-summary-value ${
                          totals.fees < 0 ? "text-danger" : "text-success"
                        }">
                        $${totals.fees.toFixed(2)}
                        </div>
                    </div>
                    <div class="header-summary-item">
                        <div class="header-summary-label">Total Funding</div>
                        <div class="header-summary-value ${
                          totals.funding >= 0 ? "text-success" : "text-danger"
                        }">
                        $${totals.funding.toFixed(2)}
                        </div>
                    </div>
                    <div class="header-summary-item">
                        <div class="header-summary-label">Total Realized</div>
                        <div class="header-summary-value ${
                          totals.realized >= 0 ? "text-success" : "text-danger"
                        }">
                        $${totals.realized.toFixed(2)}
                        </div>
                    </div>
                    </div>
                </div>

                <div class="closed-position-body">
                    <table class="closed-position-table">
                    <thead>
                        <tr>
                        <th><input type="checkbox" class="select-all-card" title="Select all"></th>
                        <th>Exchange</th><th>Symbol</th><th>Side</th><th>Size</th>
                        <th>Entry</th><th>Close</th><th>Margin</th>
                        <th>PnL</th><th>Fees</th><th>Funding</th><th>Realized</th>
                        <th>PnL %</th><th>APR</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
            </div>`;
        });
      }

      // Agregar esta funci√≥n para inicializar los filtros
      function initializeClosedFilters() {
        closedFilters = {
          exchange: "",
          symbol: "",
          side: "",
          date: "2025-09-01",
        };

        // Establecer valores por defecto en los inputs
        const filterExchange = document.getElementById("filterExchange");
        const filterSymbol = document.getElementById("filterSymbol");
        const filterSide = document.getElementById("filterSide");
        const filterDate = document.getElementById("filterDate");

        if (filterExchange) filterExchange.value = "";
        if (filterSymbol) filterSymbol.value = "";
        if (filterSide) filterSide.value = "";
        if (filterDate) filterDate.value = "2025-09-01";
      }

      // Funci√≥n para aplicar filtros y renderizar
      function applyClosedFiltersAndRender() {
        currentClosedPage = 1; // Reset a la primera p√°gina
        const filteredData = applyClosedFilters();
        renderClosedTotals(filteredData);
        renderClosedPositions(filteredData);
      }

      // Modificar la funci√≥n loadClosedPositions para cargar datos iniciales
      async function loadClosedPositions() {
        try {
          console.log("Loading closed positions from API...");
          const res = await fetch("/api/closed_positions");
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          const data = await res.json();
          console.log("[UI] /api/closed_positions payload:", data);

          closedPositionsData = Array.isArray(data?.closed_positions)
            ? data.closed_positions
            : [];

          console.log(`Loaded ${closedPositionsData.length} closed positions`);

          // Ordenar por fecha de cierre descendente (m√°s recientes primero)
          closedPositionsData.sort((a, b) => {
            const timeA = toMs(a.close_time || a.close_date);
            const timeB = toMs(b.close_time || b.close_date);
            return timeB - timeA; // Descendente
          });

          // Inicializar filtros
          initializeClosedFilters();

          // Aplicar filtros y renderizar
          applyClosedFiltersAndRender();
        } catch (error) {
          console.error("Error loading closed positions:", error);
          const container = document.getElementById("closedPositions");
          if (container) {
            container.innerHTML =
              '<p class="text-danger">Error loading closed positions: ' +
              error.message +
              "</p>";
          }
        }
      }

      // Modificar los event listeners para inicializar correctamente
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, initializing closed positions...");

        // CARGAR DATOS INICIALES
        loadClosedPositions();

        // Configurar event listeners para filtros
        const applyFiltersBtn = document.getElementById("applyFilters");
        const pageSizeSelect = document.getElementById("pageSizeSelect");
        const filterExchange = document.getElementById("filterExchange");
        const filterSymbol = document.getElementById("filterSymbol");
        const filterSide = document.getElementById("filterSide");
        const filterDate = document.getElementById("filterDate");
        const refreshClosed = document.getElementById("refreshClosed");

        if (applyFiltersBtn) {
          applyFiltersBtn.addEventListener(
            "click",
            applyClosedFiltersAndRender
          );
        }

        if (pageSizeSelect) {
          pageSizeSelect.addEventListener("change", function () {
            closedPageSize = parseInt(this.value);
            applyClosedFiltersAndRender();
          });
        }

        if (filterExchange) {
          filterExchange.addEventListener("keypress", function (e) {
            if (e.key === "Enter") applyClosedFiltersAndRender();
          });
          filterExchange.addEventListener("input", function () {
            closedFilters.exchange = this.value;
          });
        }

        if (filterSymbol) {
          filterSymbol.addEventListener("keypress", function (e) {
            if (e.key === "Enter") applyClosedFiltersAndRender();
          });
          filterSymbol.addEventListener("input", function () {
            closedFilters.symbol = this.value;
          });
        }

        if (filterSide) {
          filterSide.addEventListener("change", function () {
            closedFilters.side = this.value;
            applyClosedFiltersAndRender();
          });
        }

        if (filterDate) {
          filterDate.addEventListener("change", function () {
            closedFilters.date = this.value;
            applyClosedFiltersAndRender();
          });
        }

        if (refreshClosed) {
          refreshClosed.addEventListener("click", loadClosedPositions);
        }
        const loadClosedBtn = document.getElementById("loadClosed");
        const loadClosedStatus = document.getElementById("loadClosedStatus");

        if (loadClosedBtn) {
          loadClosedBtn.addEventListener("click", async () => {
            try {
              loadClosedBtn.disabled = true;
              loadClosedStatus.textContent = "‚è≥ Sincronizando (cache)‚Ä¶";

              // Si has escrito algo en el filtro Exchange, lo usamos para sync selectivo
              const exFilterEl = document.getElementById("filterExchange");
              const ex = (exFilterEl?.value || "").trim().toLowerCase();

              const res = await fetch("/api/closed/sync", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(ex ? { exchange: ex } : {}),
              });

              const data = await res.json();
              if (!res.ok) throw new Error(data?.error || "Sync error");

              // Construir mensaje corto
              const total = data?.total_inserted ?? 0;
              let msg = `‚úÖ ${ex || "all"}: ${total} nuevas`;
              if (data?.by_exchange && !ex) {
                const top = Object.entries(data.by_exchange)
                  .map(([k, v]) => `${k}:${v?.inserted ?? 0}`)
                  .slice(0, 5)
                  .join(" ¬∑ ");
                if (top) msg += ` | ${top}`;
              }
              loadClosedStatus.textContent = msg;

              // Recargar la lista en pantalla
              try {
                await loadClosedPositions();
              } catch (_) {}
            } catch (e) {
              loadClosedStatus.textContent = "‚ùå " + e.message;
            } finally {
              loadClosedBtn.disabled = false;
              setTimeout(() => (loadClosedStatus.textContent = ""), 5000);
            }
          });
        }
      });

      // Cargar closed positions inmediatamente
      loadClosedPositions();

      // =====================================================
      // CHECKBOX SELECTION & DELETE LOGIC FOR CLOSED POSITIONS
      // =====================================================
      function updateDeleteButtonVisibility() {
        const deleteBtn = document.getElementById("deleteSelectedClosed");
        const countSpan = document.getElementById("selectedCount");
        const checked = document.querySelectorAll(
          ".closed-pos-checkbox:checked"
        );
        const count = checked.length;

        if (deleteBtn && countSpan) {
          countSpan.textContent = count;
          deleteBtn.style.display = count > 0 ? "inline-block" : "none";
        }
      }

      // Event delegation for checkboxes
      document.addEventListener("change", function (e) {
        // Individual row checkbox
        if (e.target.classList.contains("closed-pos-checkbox")) {
          updateDeleteButtonVisibility();
        }
        // Select all checkbox in card header
        if (e.target.classList.contains("select-all-card")) {
          const table = e.target.closest("table");
          if (table) {
            const checkboxes = table.querySelectorAll(".closed-pos-checkbox");
            checkboxes.forEach((cb) => (cb.checked = e.target.checked));
            updateDeleteButtonVisibility();
          }
        }
      });

      // Delete button handler
      document
        .getElementById("deleteSelectedClosed")
        ?.addEventListener("click", async function () {
          const checked = document.querySelectorAll(
            ".closed-pos-checkbox:checked"
          );
          const ids = Array.from(checked)
            .map((cb) => parseInt(cb.dataset.id))
            .filter((id) => id > 0);

          if (ids.length === 0) return;

          const confirmed = confirm(
            `¬øEst√°s seguro de que quieres borrar ${ids.length} posici√≥n(es) cerrada(s)?\n\nEsta acci√≥n no se puede deshacer.`
          );
          if (!confirmed) return;

          try {
            this.disabled = true;
            this.textContent = "üóëÔ∏è Borrando...";

            const res = await fetch("/api/closed/delete", {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ids: ids }),
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data?.error || "Error al borrar");

            alert(`‚úÖ ${data.deleted} posici√≥n(es) borrada(s)`);

            // Recargar la lista
            await loadClosedPositions();
          } catch (e) {
            alert("‚ùå Error: " + e.message);
          } finally {
            this.disabled = false;
            updateDeleteButtonVisibility();
          }
        });

      // Tambi√©n agregar un event listener para cuando se muestre la pesta√±a de Closed Positions
      document.addEventListener("DOMContentLoaded", function () {
        const closedTab = document.getElementById("closed-tab");
        if (closedTab) {
          closedTab.addEventListener("shown.bs.tab", function () {
            console.log("Closed tab shown");
            // Si no hay datos cargados, cargarlos
            if (closedPositionsData.length === 0) {
              loadClosedPositions();
            }
          });
        }
        document
          .getElementById("btn-import-ourbit")
          ?.addEventListener("click", async () => {
            const exchange = document.getElementById("opt-exchange").value;
            const product = document.getElementById("opt-product").value;
            const fFund = document.getElementById("opt-fund").files[0] || null;
            const fFills =
              document.getElementById("opt-fills").files[0] || null;

            const st = document.getElementById("import-status");
            const fd = new FormData();
            fd.append("exchange", exchange);
            fd.append("product_type", product);

            // Diferentes nombres de campos seg√∫n el exchange
            if (exchange === "ourbit") {
              if (fFund) fd.append("fund_flow", fFund);
              if (fFills) fd.append("fills", fFills);
            } else if (exchange === "kcex") {
              if (fFund) fd.append("capital_flow", fFund);
              if (fFills) fd.append("trade_history", fFills);
            }

            st.textContent = "Importando‚Ä¶";
            try {
              const res = await fetch("/api/manual/import", {
                method: "POST",
                body: fd,
              });
              const data = await res.json();
              if (!res.ok)
                throw new Error(data?.error || "Error de importaci√≥n");

              // Mensaje seg√∫n exchange
              if (exchange === "kcex") {
                st.textContent = `‚úÖ Funding: ${
                  data.funding_saved || 0
                } | Posiciones: ${data.positions_saved || 0}`;
              } else {
                st.textContent = `‚úÖ Funding: ${
                  data.funding_inserted || 0
                } | Closed: ${data.closed_inserted || 0} (roundtrips: ${
                  data.roundtrips_detected || 0
                })`;
              }
            } catch (e) {
              st.textContent = "‚ùå " + e.message;
            }
          });

        // Cambiar labels seg√∫n el exchange seleccionado
        document
          .getElementById("opt-exchange")
          ?.addEventListener("change", function () {
            const exchange = this.value;
            const label1 = document.getElementById("file1-label");
            const label2 = document.getElementById("file2-label");

            if (exchange === "ourbit") {
              label1.textContent = "Fund flow (Funding fees)";
              label2.textContent = "Fills history (opcional)";
            } else if (exchange === "kcex") {
              label1.textContent = "Capital Flow (Funding fees)";
              label2.textContent = "Trade History";
            } else if (exchange === "lbank") {
              label1.textContent = "Futures CSV (Funding fees)";
              label2.textContent = "Filled CSV (Trades)";
            }
          });
        function parseLocalDateTimeToSeconds(value) {
          if (!value) return 0;
          // value viene como 'YYYY-MM-DDTHH:mm' en hora local ‚Üí a epoch segundos
          const ms = Date.parse(value);
          return Number.isFinite(ms) ? Math.floor(ms / 1000) : 0;
        }

        document
          .getElementById("btn-save-manual-closed")
          ?.addEventListener("click", async () => {
            const st = document.getElementById("manual-closed-status");
            const payload = {
              exchange:
                document.getElementById("m-exchange").value?.trim() || "",
              symbol: document.getElementById("m-symbol").value?.trim() || "",
              side: document.getElementById("m-side").value?.trim() || "",
              size: Number(document.getElementById("m-size").value || 0),
              entry_price: Number(
                document.getElementById("m-entry").value || 0
              ),
              close_price: Number(
                document.getElementById("m-close").value || 0
              ),
              open_time: parseLocalDateTimeToSeconds(
                document.getElementById("m-open").value
              ),
              close_time: parseLocalDateTimeToSeconds(
                document.getElementById("m-close-time").value
              ),
              funding_total: Number(
                document.getElementById("m-funding").value || 0
              ),
              fee_total: Number(document.getElementById("m-fees").value || 0),
              realized_pnl:
                document.getElementById("m-realized").value === ""
                  ? null
                  : Number(document.getElementById("m-realized").value),
              initial_margin:
                document.getElementById("m-initial-margin").value === ""
                  ? null
                  : Number(document.getElementById("m-initial-margin").value),
              notional:
                document.getElementById("m-notional").value === ""
                  ? null
                  : Number(document.getElementById("m-notional").value),
              leverage:
                document.getElementById("m-leverage").value === ""
                  ? null
                  : Number(document.getElementById("m-leverage").value),
              liquidation_price:
                document.getElementById("m-liq").value === ""
                  ? null
                  : Number(document.getElementById("m-liq").value),
            };

            // Validaci√≥n m√≠nima
            if (
              !payload.exchange ||
              !payload.symbol ||
              !payload.side ||
              !payload.size ||
              !payload.entry_price ||
              !payload.close_price ||
              !payload.close_time
            ) {
              st.textContent =
                "‚ùå Rellena como m√≠nimo: exchange, symbol, side, size, entry, close, close time.";
              return;
            }

            st.textContent = "Guardando...";
            try {
              const res = await fetch("/api/manual/closed", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data?.error || "Error guardando");

              st.textContent = `‚úÖ Guardado (id ${data.id || "?"}).`;
              // refrescar pesta√±a "Closed Positions"
              try {
                await loadClosedPositions();
              } catch (e) {}
            } catch (e) {
              st.textContent = "‚ùå " + e.message;
            }
          });
        document
          .getElementById("btn-force-closed")
          ?.addEventListener("click", async () => {
            const st = document.getElementById("force-status");
            const exchanges = getCheckedValuesFromSelector(
              ".force-exchange-checkbox:checked"
            );
            const daysInput = parseInt(
              document.getElementById("force-days").value,
              10
            );
            const days = Math.min(
              90,
              Math.max(1, Number.isFinite(daysInput) ? daysInput : 30)
            );

            if (!exchanges.length) {
              st.textContent = "‚ùå Selecciona al menos un exchange.";
              return;
            }

            st.textContent = "‚è≥ Cargando cerradas‚Ä¶";
            try {
              const summaries = [];
              for (const exchange of exchanges) {
                try {
                  const res = await fetch("/api/closed/load", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ exchange, days }),
                  });
                  const data = await res.json();

                  if (!res.ok) throw new Error(data?.error || "Sync error");

                  const ins = data?.inserted ?? data?.saved ?? 0;
                  const upd = data?.updated ?? 0;
                  const skp = data?.skipped ?? 0;
                  summaries.push(
                    `‚úÖ ${exchange}: nuevas=${ins} actualizadas=${upd} omitidas=${skp}`
                  );
                } catch (err) {
                  summaries.push(`‚ùå ${exchange}: ${err.message}`);
                }
              }
              st.innerHTML = `${summaries.join(
                "<br>"
              )}<br/><small>Ventana: √∫ltimos ${days} d√≠as</small>`;

              try {
                await loadClosedPositions();
              } catch (_) {}
            } catch (e) {
              st.textContent = "‚ùå " + e.message;
            }
          });
        document
          .getElementById("btn-force-funding")
          ?.addEventListener("click", async () => {
            const st = document.getElementById("force-funding-status");
            const exchanges = getCheckedValuesFromSelector(
              ".funding-exchange-checkbox:checked"
            );
            const daysInput = parseInt(
              document.getElementById("funding-force-days").value,
              10
            );
            const days = Math.min(
              90,
              Math.max(1, Number.isFinite(daysInput) ? daysInput : 14)
            );

            if (!exchanges.length) {
              st.textContent = "‚ùå Selecciona al menos un exchange.";
              return;
            }

            st.textContent = "‚è≥ Cargando funding‚Ä¶";
            try {
              const res = await fetch("/api/funding/force", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ exchanges, days }),
              });
              const data = await res.json();
              if (!res.ok || data?.ok === false) {
                throw new Error(data?.error || "Funding sync error");
              }

              const resultMap = data?.results || {};
              const lines = exchanges.map(
                (ex) =>
                  `‚úÖ ${ex}: ${Number(
                    resultMap[ex] || 0
                  )} registros (√∫ltimos ${days} d√≠as)`
              );
              st.innerHTML = lines.join("<br>");
            } catch (err) {
              st.textContent = "‚ùå " + err.message;
            }
          });
      });
    </script>

    <script>
      // ====== Refresh Open Positions ======
      window.loadOpenPositions = function () {
        // Route any legacy reload calls through the scoped refresh
        return refreshOpenPositions();
      };

      // ========================================
      // EXCHANGE CHECKBOXES
      // ========================================
      document
        .getElementById("check-all-exchanges")
        .addEventListener("change", function () {
          document
            .querySelectorAll(".exchange-checkbox")
            .forEach((cb) => (cb.checked = this.checked));
        });

      document.querySelectorAll(".exchange-checkbox").forEach((checkbox) => {
        checkbox.addEventListener("change", function () {
          syncMasterExchangeToggle();
        });
      });

      function getSelectedExchanges() {
        return Array.from(
          document.querySelectorAll(".exchange-checkbox:checked")
        ).map((cb) => cb.value);
      }

      function syncMasterExchangeToggle() {
        const master = document.getElementById("check-all-exchanges");
        if (!master) return;
        const checkboxes = Array.from(
          document.querySelectorAll(".exchange-checkbox")
        );
        if (!checkboxes.length) {
          master.checked = false;
          return;
        }
        master.checked = checkboxes.every((cb) => cb.checked);
      }

      function applyExchangeSelection(exchanges) {
        if (!Array.isArray(exchanges) || exchanges.length === 0) {
          return false;
        }
        const desired = new Set(
          exchanges.map((ex) => (ex || "").toLowerCase())
        );
        let matched = false;
        document.querySelectorAll(".exchange-checkbox").forEach((cb) => {
          const shouldCheck = desired.has((cb.value || "").toLowerCase());
          cb.checked = shouldCheck;
          matched = matched || shouldCheck;
        });
        if (!matched) {
          document
            .querySelectorAll(".exchange-checkbox")
            .forEach((cb) => (cb.checked = true));
          syncMasterExchangeToggle();
          return false;
        }
        syncMasterExchangeToggle();
        return true;
      }

      function setupGroupCheckbox(masterSelector, itemSelector) {
        const master = document.querySelector(masterSelector);
        const sync = () => {
          if (!master) return;
          const boxes = Array.from(document.querySelectorAll(itemSelector));
          if (!boxes.length) {
            master.checked = false;
            return;
          }
          master.checked = boxes.every((cb) => cb.checked);
        };

        if (master) {
          master.addEventListener("change", () => {
            document.querySelectorAll(itemSelector).forEach((cb) => {
              cb.checked = master.checked;
            });
          });
        }

        document.querySelectorAll(itemSelector).forEach((cb) => {
          cb.addEventListener("change", () => sync());
        });

        sync();
      }

      function getCheckedValuesFromSelector(selector) {
        return Array.from(document.querySelectorAll(selector))
          .filter((cb) => cb.checked)
          .map((cb) => cb.value);
      }

      async function hydrateExchangeSelection() {
        try {
          const resp = await fetch("/api/positions/exchanges");
          if (!resp.ok) return;
          const data = await resp.json();
          applyExchangeSelection(
            Array.isArray(data?.exchanges) ? data.exchanges : []
          );
        } catch (err) {
          console.error(
            "No se pudieron cargar las preferencias de exchanges",
            err
          );
        } finally {
          syncMasterExchangeToggle();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        setupGroupCheckbox("#force-check-all", ".force-exchange-checkbox");
        setupGroupCheckbox("#funding-check-all", ".funding-exchange-checkbox");
        hydrateExchangeSelection()
          .catch((err) => {
            console.error(
              "‚ùå No se pudieron cargar las preferencias de exchanges:",
              err
            );
          })
          .finally(() => {
            loadFundingData()
              .then(() => console.log("‚úÖ Funding data loaded"))
              .catch((err) =>
                console.error("‚ùå Error loading funding data:", err)
              );
            try {
              refreshOpenPositions();
            } catch (err) {
              console.error(
                "No se pudieron refrescar las posiciones al iniciar",
                err
              );
            }
          });
      });

      // ========================================
      // MODIFIED refreshPositions
      // ========================================
      async function refreshPositions() {
        // Use full page reload to reuse the stable initial render pipeline
        try {
          window.location.reload();
        } catch (e) {
          console.error("Refresh failed:", e);
        }
      }

      // Scoped refresh for Open Positions using selected exchanges
      async function refreshOpenPositions() {
        const btn = document.getElementById("refreshOpen");
        const originalText = btn ? btn.innerText : null;
        const exchanges = getSelectedExchanges();
        try {
          if (btn) {
            btn.disabled = true;
            btn.innerText = "Refreshing...";
          }
          const hasFilter = exchanges && exchanges.length > 0;
          const resp = await fetch("/api/positions", {
            method: hasFilter ? "POST" : "GET",
            headers: hasFilter
              ? { "Content-Type": "application/json" }
              : undefined,
            body: hasFilter ? JSON.stringify({ exchanges }) : undefined,
          });
          const data = await resp.json();
          const rows = Array.isArray(data?.positions) ? data.positions : [];
          // Re-render using the existing helper
          renderOpenPositionsFromRows(rows);
          // Update funding aggregates for the visible positions
          updateFundingForOpenPositions();
        } catch (e) {
          console.error("Failed to refresh open positions", e);
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerText = originalText || "üîÑ Refresh";
          }
        }
      }

      // ========================================
      // FUNDING d-2, d-1, hoy
      // ========================================
      async function updateFundingForOpenPositions() {
        // Esperar a que allFundingData est√© cargado
        if (!window.allFundingData || !window.allFundingData.length) {
          console.log("‚è≥ Waiting for funding data to load...");
          return;
        }

        // Obtener todas las posiciones visibles en la UI
        const positionCards = document.querySelectorAll(
          "[data-symbol][data-exchange]"
        );

        positionCards.forEach((card) => {
          const baseSymbol = card.getAttribute("data-symbol");
          const exchange = card.getAttribute("data-exchange");

          if (!baseSymbol) return;

          // Calcular funding para los √∫ltimos 3 d√≠as usando allFundingData
          const f3 = fundingLast3Days(baseSymbol);

          updatePositionFunding(exchange, baseSymbol, {
            d2: f3.d2,
            d1: f3.d1,
            today: f3.d0,
          });
        });
      }

      function updatePositionFunding(exchange, baseSymbol, funding) {
        const els = {
          d2: document.querySelector(
            `.funding-d2[data-exchange="${exchange}"][data-symbol="${baseSymbol}"]`
          ),
          d1: document.querySelector(
            `.funding-d1[data-exchange="${exchange}"][data-symbol="${baseSymbol}"]`
          ),
          today: document.querySelector(
            `.funding-today[data-exchange="${exchange}"][data-symbol="${baseSymbol}"]`
          ),
        };
        if (els.d2) {
          els.d2.textContent = "$" + formatNumber(funding.d2 || 0, 2);
          els.d2.className =
            "metric-value-sm funding-d2 " +
            (funding.d2 >= 0 ? "text-success" : "text-danger");
        }
        if (els.d1) {
          els.d1.textContent = "$" + formatNumber(funding.d1 || 0, 2);
          els.d1.className =
            "metric-value-sm funding-d1 " +
            (funding.d1 >= 0 ? "text-success" : "text-danger");
        }
        if (els.today) {
          els.today.textContent = "$" + formatNumber(funding.today || 0, 2);
          els.today.className =
            "metric-value-sm funding-today " +
            (funding.today >= 0 ? "text-success" : "text-danger");
        }
      }

      // ========================================
      // EDIT MODAL
      // ========================================
      let currentEditPosition = null;

      function openEditModal(position) {
        currentEditPosition = position;
        document.getElementById("edit-exchange").value =
          position?.exchange || "";
        document.getElementById("edit-symbol").value = position?.symbol || "";
        document.getElementById("edit-side").value = (
          position?.side || "long"
        ).toLowerCase();
        document.getElementById("edit-size").value = position?.size || "";
        document.getElementById("edit-entry-price").value =
          position?.entry_price || "";
        document.getElementById("edit-liq").value =
          position?.liquidation_price || "";
        document.getElementById("edit-fees").value = position?.fee || "";
        document.getElementById("edit-funding").value =
          position?.funding_fee || "";
        document.getElementById("edit-realized-pnl").value =
          position?.realized_pnl || "";
        document.getElementById("edit-init-margin").value =
          position?.init_margin || "";
        document.getElementById("edit-margin").value =
          position?.main_margin || "";
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      document
        .getElementById("save-edit-btn")
        .addEventListener("click", async function () {
          if (!currentEditPosition) return;

          const updates = {
            exchange: currentEditPosition.exchange,
            symbol: currentEditPosition.symbol,
            side: document.getElementById("edit-side").value || null,
            size:
              parseFloat(document.getElementById("edit-size").value) || null,
            entry_price:
              parseFloat(document.getElementById("edit-entry-price").value) ||
              null,
            liquidation_price:
              parseFloat(document.getElementById("edit-liq").value) || null,
            fee: parseFloat(document.getElementById("edit-fees").value) || null,
            funding_fee:
              parseFloat(document.getElementById("edit-funding").value) || null,
            realized_pnl:
              parseFloat(document.getElementById("edit-realized-pnl").value) ||
              null,
            init_margin:
              parseFloat(document.getElementById("edit-init-margin").value) ||
              null,
            main_margin:
              parseFloat(document.getElementById("edit-margin").value) || null,
            updated_at: Date.now(),
          };

          try {
            const response = await fetch("/api/positions/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updates),
            });

            if (!response.ok) {
              throw new Error("Failed to save position updates");
            }

            // Close modal
            bootstrap.Modal.getInstance(
              document.getElementById("editModal")
            ).hide();

            // Show success message
            alert(
              "Position updated successfully! Refresh manually to see changes."
            );
          } catch (error) {
            console.error("Error saving position:", error);
            alert("Error saving position: " + error.message);
          }
        });

      // ========================================
      // AUTO-REFRESH (every hour at :01)
      // ========================================
      function scheduleHourlyRefresh() {
        const computeDelay = () => {
          const now = new Date();
          const target = new Date(now);
          if (now.getMinutes() >= 1) {
            target.setHours(target.getHours() + 1);
          }
          target.setMinutes(1, 0, 0);
          const diff = target.getTime() - now.getTime();
          // Garantiza un m√≠nimo de 5 segundos para evitar bucles muy r√°pidos
          return Math.max(diff, 5000);
        };

        const scheduleNext = () => {
          const delay = computeDelay();
          const minutes = Math.round(delay / 60000);
          console.log(`‚è∞ Pr√≥ximo auto-refresh en ${minutes} min`);
          setTimeout(async () => {
            console.log(
              "üîÑ Auto-refresh (cache selection) " +
                new Date().toLocaleTimeString()
            );
            try {
              await refreshOpenPositions();
            } catch (err) {
              console.error("Auto-refresh failed", err);
            } finally {
              scheduleNext();
            }
          }, delay);
        };

        scheduleNext();
      }

      // Bot√≥n de refresh
      document.addEventListener("DOMContentLoaded", function () {
        const refreshOpen = document.getElementById("refreshOpen");
        if (refreshOpen) {
          refreshOpen.addEventListener("click", function () {
            console.log("üîÑ Refreshing open positions (scoped)...");
            refreshOpenPositions();
          });
        }
        scheduleHourlyRefresh();
      });
    </script>

    <script>
      // ====== Manual Open (UI) ======
      (function () {
        const addManualBtn = document.getElementById("btnAddManualOpen");
        const modalManualEl = document.getElementById("modalManualOpen");
        const modalManualOpen = modalManualEl
          ? new bootstrap.Modal(modalManualEl)
          : null;
        const manualOpenMsg = document.getElementById("manualOpenMsg");

        if (addManualBtn) {
          addManualBtn.addEventListener("click", () => {
            if (document.getElementById("formManualOpen"))
              document.getElementById("formManualOpen").reset();
            if (manualOpenMsg) manualOpenMsg.textContent = "";
            modalManualOpen && modalManualOpen.show();
          });
        }

        document
          .getElementById("btnManualOpenSave")
          ?.addEventListener("click", async () => {
            if (manualOpenMsg) manualOpenMsg.textContent = "Saving‚Ä¶";
            const form = document.getElementById("formManualOpen");
            const fd = new FormData(form);
            const payload = Object.fromEntries(fd.entries());

            // Convertir datetime-local a epoch seconds
            if (payload.open_time) {
              const dateValue = new Date(payload.open_time);
              payload.open_time = Math.floor(dateValue.getTime() / 1000);
            }

            try {
              const res = await fetch("/api/open/manual/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              const data = await res.json();
              if (!res.ok || !data.ok)
                throw new Error(data.error || "Error saving manual open");
              if (manualOpenMsg) manualOpenMsg.textContent = "‚úÖ Saved";
              modalManualOpen && modalManualOpen.hide();
              // No auto-refresh - user will refresh manually
              alert("Manual position added! Refresh to see it.");
            } catch (e) {
              if (manualOpenMsg) manualOpenMsg.textContent = "‚ùå " + e.message;
            }
          });

        // Send to closed
        const modalSendEl = document.getElementById("modalSendClosed");
        const modalSendClosed = modalSendEl
          ? new bootstrap.Modal(modalSendEl)
          : null;
        const sendClosedMsg = document.getElementById("sendClosedMsg");

        document
          .getElementById("btnSendClosedSave")
          ?.addEventListener("click", async () => {
            if (sendClosedMsg) sendClosedMsg.textContent = "Sending‚Ä¶";
            const form = document.getElementById("formSendClosed");
            const fd = new FormData(form);
            const payload = Object.fromEntries(fd.entries());
            payload.close_price = payload.close_price
              ? Number(payload.close_price)
              : null;
            payload.pnl = payload.pnl ? Number(payload.pnl) : null;
            payload.close_time = payload.close_time
              ? Number(payload.close_time)
              : null;

            try {
              const res = await fetch("/api/open/manual/close", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              const data = await res.json();
              if (!res.ok || !data.ok)
                throw new Error(data.error || "Error sending to closed");
              if (sendClosedMsg) sendClosedMsg.textContent = "‚úÖ Sent";
              modalSendClosed && modalSendClosed.hide();
              try {
                window.loadOpenPositions && window.loadOpenPositions();
              } catch (e) {}
              try {
                window.loadClosedPositions && window.loadClosedPositions();
              } catch (e) {}
            } catch (e) {
              if (sendClosedMsg) sendClosedMsg.textContent = "‚ùå " + e.message;
            }
          });

        // Delegation for Delete / Send buttons in rows
        document.addEventListener("click", async (ev) => {
          const btn =
            ev.target.closest && ev.target.closest("button[data-action]");
          if (!btn) return;
          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          if (action === "del") {
            if (!confirm("¬øDelete manual open position?")) return;
            try {
              const res = await fetch("/api/open/manual/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ manual_id: id }),
              });
              const data = await res.json();
              if (data?.ok) {
                try {
                  window.loadOpenPositions && window.loadOpenPositions();
                } catch (e) {}
              } else {
                alert("Delete failed: " + (data?.error || ""));
              }
            } catch (e) {
              alert("Delete failed: " + e.message);
            }
          } else if (action === "send") {
            if (!document.querySelector("#formSendClosed")) return;
            document.querySelector("#formSendClosed").reset();
            document.querySelector("#formSendClosed [name=manual_id]").value =
              id;
            modalSendClosed && modalSendClosed.show();
          }
        });
      })();
    </script>

    <!-- Auto-reload for development - DESACTIVADO -->
    <!-- Para ver cambios al momento: simplemente recarga con F5 o Ctrl+R -->
    <!-- Flask con debug=True ya recarga autom√°ticamente el servidor -->
    <script>
      // Auto-reload desactivado para evitar spam en consola
      // Si quieres activarlo, descomenta el c√≥digo de abajo
      /*
      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        let lastModified = null;

        setInterval(async () => {
          try {
            const response = await fetch(window.location.href, {
              method: "HEAD",
              cache: "no-cache",
            });

            const currentModified = response.headers.get("Last-Modified");

            if (
              lastModified &&
              currentModified &&
              lastModified !== currentModified
            ) {
              console.log("üîÑ Cambios detectados, recargando p√°gina...");
              window.location.reload();
            }

            lastModified = currentModified;
          } catch (e) {
            // Silently fail if server is down
          }
        }, 1000); // Chequea cada segundo
      }
      */
    </script>
  </body>
</html>
